@model PIM_FINAL.Models.Chamado
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers

@* Página DetalhesMeuChamado: mostra informações do chamado do solicitante, histórico, comunicações, anexos e envio de nova mensagem. *@
<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Detalhes (Meus Chamados) - SoftForge HelpDesk</title>
<link rel="stylesheet" href="/css/dbtestes.css" />
</head>
<body>
<div class="db-page container-fluid">
 @await Html.PartialAsync("_HeaderNav")

 <main class="db-content">
 <section class="db-section db-welcome">
 <h2>Detalhes do Chamado @(Model.Protocolo ?? "#")</h2>
 <p><a asp-controller="Site" asp-action="MeusChamados">⬅ Voltar para lista de chamados</a></p>
 </section>

 <section>
 <h3>Informações do Chamado</h3>
<table class="table table-bordered w-100 stack-mobile limit-rows" data-limit="3">
 <thead><tr><th>Campo</th><th>Valor</th></tr></thead>
 <tbody>
 <tr><td><strong>Protocolo</strong></td><td><span class="cell-val">@(Model.Protocolo ?? "#")</span></td></tr>
 <tr><td><strong>Status</strong></td><td><span class="cell-val">@(Model.StatusChamado?.NomeStatus ?? "-")</span></td></tr>
 <tr><td><strong>Título</strong></td><td><span class="cell-val">@Model.Titulo</span></td></tr>
 <tr><td><strong>Descrição</strong></td><td><span class="cell-val wrap">@Model?.Descricao</span></td></tr>
 <tr><td><strong>Categoria</strong></td><td><span class="cell-val">@(Model.Categoria?.NomeCategoria ?? "-")</span></td></tr>
 <tr><td><strong>Prioridade</strong></td><td><span class="cell-val">@(Model.Prioridade?.NomePrioridade ?? "-")</span></td></tr>
 <tr><td><strong>Data/Hora Abertura</strong></td><td><span class="cell-val">@(Model.DataAbertura?.ToLocalTime().ToString("g") ?? "-")</span></td></tr>
 <tr><td><strong>Técnico Responsável</strong></td><td><span class="cell-val">@(Model.TecnicoResponsavel?.NomeCompleto ?? "Não atribuído")</span></td></tr>
 <tr><td><strong>Previsão de Resolução (SLA)</strong></td><td><span class="cell-val">-</span></td></tr>
 </tbody>
</table>
</section>

<section>
<h3>Histórico de Atendimentos</h3>
<table class="table table-bordered w-100 stack-mobile limit-rows" data-limit="3">
<thead><tr><th>Data/Hora</th><th>Técnico</th><th>Ação</th></tr></thead>
<tbody>
@foreach(var a in Model.Atendimentos)
{ <tr><td><span class="cell-val">@(a.DataAtendimento?.ToLocalTime().ToString("g") ?? "-")</span></td><td><span class="cell-val">@(a.UsuarioTecnico?.NomeCompleto ?? "-")</span></td><td><span class="cell-val">@a.AcaoRealizada</span></td></tr> }
</tbody>
</table>
</section>

<section>
<h3>Comunicações</h3>
<div>
@foreach(var m in Model.Comunicacoes.OrderBy(c => c.DataEnvio))
{ <div class="db-msg-box"><p><strong>@(m.Usuario?.NomeCompleto ?? "")</strong> - @(m.DataEnvio?.ToLocalTime().ToString("g") ?? "")</p><p>@m.Mensagem</p></div> }
</div>
@if (TempData["SuccessMessage"] != null){<div class="alert alert-success">@TempData["SuccessMessage"]</div>}
@if (TempData["ErrorMessage"] != null){<div class="alert alert-danger">@TempData["ErrorMessage"]</div>}
</section>

<section>
<h3>Anexos</h3>
<ul>
@foreach(var a in Model.Anexos){<li><a asp-controller="Site" asp-action="DownloadAnexo" asp-route-id="@a.AnexoId">@a.NomeArquivo</a> (@(a.TipoArquivo ?? "-")) - @(a.DataUpload?.ToLocalTime().ToString("g") ?? "-")</li>}
</ul>
</section>

<section>
<h3>Enviar Mensagem</h3>
<form method="post" asp-controller="Site" asp-action="EnviarMensagem">
<input type="hidden" name="chamado_id" value="@Model.ChamadoId" />
<label for="mensagem">Mensagem:</label><br />
<textarea id="mensagem" name="mensagem" rows="4" cols="80" placeholder="Digite sua mensagem..."></textarea><br /><br />
<button type="submit" class="btn btn-primary btn-sm">Enviar Mensagem</button>
</form>
</section>
 </main>

 <div class="db-footer">
 <footer><p>©2025 SoftForge - Todos os direitos reservados</p></footer>
 </div>
</div>
</body>
</html>
