// Please see documentation at https://learn.microsoft.com/aspnet/core/client-side/bundling-and-minification
// for details on configuring this project to bundle and minify static web assets.

// Global site script: list/table limiting
(function(){
 // ---- Utilities ----
 function onReady(fn){
 if(document.readyState === 'loading') document.addEventListener('DOMContentLoaded', fn); else fn();
 }
 function makeButton(text, cls){
 const btn = document.createElement('button');
 btn.type = 'button';
 btn.className = cls || 'btn btn-sm btn-secondary';
 btn.textContent = text || 'Mostrar mais';
 return btn;
 }

 // ---- Limit rows in lists/tables (merged from limitLists.js) ----
 const DEFAULT_LIMIT =3;
 const DEFAULT_TABLE_COUNT_LIMIT =3;
 function readLimit(el){ const n = parseInt(el.getAttribute('data-limit'),10); return Number.isFinite(n)&&n>0?n:DEFAULT_LIMIT; }
 function readTableCountLimit(){ const n = parseInt(document.body.getAttribute('data-max-tables'),10); return Number.isFinite(n)&&n>0?n:DEFAULT_TABLE_COUNT_LIMIT; }

 function applyToList(list){
 const limit = readLimit(list);
 const items = Array.from(list.children).filter(n=>n.nodeType===1);
 if(items.length <= limit) return;
 const hidden = items.slice(limit);
 hidden.forEach(li=>li.classList.add('is-hidden'));
 const btn = makeButton('Mostrar mais','btn btn-sm btn-secondary limit-toggle');
 btn.addEventListener('click',()=>{
 const expanded = hidden[0].classList.contains('is-hidden')===false;
 hidden.forEach(li=>li.classList.toggle('is-hidden', expanded));
 btn.textContent = expanded? 'Mostrar mais':'Mostrar menos';
 });
 const wrap = document.createElement('div');
 wrap.appendChild(btn);
 list.parentNode.insertBefore(wrap, list.nextSibling);
 }

 function applyToTable(table){
 const limit = readLimit(table);
 const rows = Array.from(table.querySelectorAll('tbody tr'));
 if(rows.length <= limit) return;
 const hidden = rows.slice(limit);
 hidden.forEach(r=>r.classList.add('is-hidden'));
 const btn = makeButton('Mostrar mais','btn btn-sm btn-secondary limit-toggle');
 btn.addEventListener('click',()=>{
 const expanded = hidden[0].classList.contains('is-hidden')===false;
 hidden.forEach(r=>r.classList.toggle('is-hidden', expanded));
 btn.textContent = expanded? 'Mostrar mais':'Mostrar menos';
 });
 const wrap = document.createElement('div');
 wrap.className = 'limit-wrap';
 wrap.style.marginTop = '4px';
 wrap.appendChild(btn);
 table.parentNode.insertBefore(wrap, table.nextSibling);
 }

 function applyTableCountLimit(){
 const limit = readTableCountLimit();
 const tables = Array.from(document.querySelectorAll('table.limit-table'));
 if(tables.length <= limit) return;
 const hiddenSections = tables.slice(limit).map(t=>t.closest('.db-section')||t).filter(Boolean);
 hiddenSections.forEach(sec=>sec.classList.add('is-hidden'));
 const btn = makeButton('Mostrar mais tabelas','btn btn-sm btn-secondary limit-toggle');
 btn.addEventListener('click',()=>{
 const collapsed = hiddenSections[0].classList.contains('is-hidden')===false;
 hiddenSections.forEach(sec=>sec.classList.toggle('is-hidden', collapsed));
 btn.textContent = collapsed? 'Mostrar mais tabelas':'Mostrar menos tabelas';
 });
 const anchorSec = (tables[limit-1].closest('.db-section') || tables[limit-1]);
 const wrap = document.createElement('div');
 wrap.className = 'limit-table-wrap';
 wrap.style.margin = '8px0';
 wrap.appendChild(btn);
 anchorSec.parentNode.insertBefore(wrap, anchorSec.nextSibling);
 }

 // Validação simples de confirmação de senha
 function attachCadastroValidation(){
 const form = document.getElementById('cadForm');
 if(!form) return;
 form.addEventListener('submit', function(e){
 const senha = document.getElementById('senha');
 const confirma = document.getElementById('confirma_senha');
 if(senha && confirma && senha.value!==confirma.value){
 e.preventDefault();
 alert('As senhas não coincidem.');
 }
 });
 }

 function attachRegistroValidation(){
 const form = document.getElementById('registroForm');
 if(!form) return;
 form.addEventListener('submit', function(e){
 const senha = document.getElementById('senha');
 const confirma = document.getElementById('confirma_senha');
 if(senha && confirma && senha.value!==confirma.value){
 e.preventDefault();
 alert('As senhas não coincidem.');
 }
 });
 }

 // Toggle de notificações (painel inicial)
 function attachNotifToggle(){
 const btn = document.getElementById('toggleNotif');
 const rest = document.getElementById('notifRest');
 if(!btn||!rest) return;
 btn.addEventListener('click',()=>{
 const visible = rest.style.display!=='none';
 rest.style.display=visible? 'none':'block';
 btn.textContent=visible? 'Mostrar mais':'Mostrar menos';
 if(!visible){ // scroll até o final das notificações
 rest.scrollIntoView({behavior:'smooth', block:'end'});
 }
 });
 }

 // Restaura filtros (Meus Chamados) usando data-current se presente
 function restoreMeusChamadosFilters(){
 const statusSel = document.getElementById('filtro_status');
 const prioridadeSel = document.getElementById('filtro_prioridade');
 const pick=(sel, globalName)=>{ if(!sel) return; const v=sel.getAttribute('data-current')||window[globalName]; if(v){ for(let i=0;i<sel.options.length;i++){ if(sel.options[i].value===v){ sel.selectedIndex=i; break; } } } };
 pick(statusSel,'MeusChamadosStatus');
 pick(prioridadeSel,'MeusChamadosPrioridade');
 }

 onReady(()=>{
 // hidden css for toggle
 if(!document.getElementById('limitlists-hidden-style')){
 const style = document.createElement('style');
 style.id = 'limitlists-hidden-style';
 style.textContent = '.is-hidden{display:none !important}';
 document.head.appendChild(style);
 }
 // apply limiters
 document.querySelectorAll('ul.limit-rows:not(.no-limit), ol.limit-rows:not(.no-limit)')
 .forEach(applyToList);
 document.querySelectorAll('table.limit-rows:not(.no-limit)')
 .forEach(applyToTable);
 applyTableCountLimit();
 // migrated scripts
 attachCadastroValidation();
 attachRegistroValidation();
 attachNotifToggle();
 restoreMeusChamadosFilters();
 });
})();
