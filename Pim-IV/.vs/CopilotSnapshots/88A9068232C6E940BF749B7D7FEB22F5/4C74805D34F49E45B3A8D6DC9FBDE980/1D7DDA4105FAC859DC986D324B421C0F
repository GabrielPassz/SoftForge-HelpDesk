@model PIM_FINAL.Models.Chamado @* Modelo do chamado para o solicitante *@
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers @* TagHelpers *@
<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" /> @* Codificação *@
<meta name="viewport" content="width=device-width, initial-scale=1.0" /> @* Responsivo *@
<title>Detalhes (Meus Chamados) - SoftForge HelpDesk</title> @* Título *@
<link rel="stylesheet" href="/css/dbtestes.css" /> @* Estilos *@
</head>
<body>
<div class="db-page container-fluid"> @* Container principal *@
 @await Html.PartialAsync("_HeaderNav") @* Cabeçalho/menu *@

 <main class="db-content"> @* Conteúdo *@
 <section class="db-section db-welcome"> @* Cabeçalho e retorno *@
 <h2>Detalhes do Chamado @(Model.Protocolo ?? "#")</h2>
 <p><a asp-controller="Site" asp-action="MeusChamados">⬅ Voltar para lista de chamados</a></p>
 </section>

 <section> @* Informações principais do chamado *@
 <h3>Informações do Chamado</h3>
<table class="table table-bordered w-100 stack-mobile limit-rows" data-limit="3">
 <thead>
 <tr>
 <th>Campo</th>
 <th>Valor</th>
 </tr>
 </thead>
 <tbody>
 <tr>
 <td data-label="Campo"><strong>Protocolo</strong></td>
 <td data-label="Protocolo"><span class="cell-val">@(Model.Protocolo ?? "#")</span></td>
 </tr>
 <tr>
 <td data-label="Campo"><strong>Status</strong></td>
 <td data-label="Status"><span class="cell-val">@(Model.StatusChamado?.NomeStatus ?? "-")</span></td>
 </tr>
 <tr>
 <td data-label="Campo"><strong>Título</strong></td>
 <td data-label="Título"><span class="cell-val">@Model.Titulo</span></td>
 </tr>
 <tr>
 <td data-label="Campo"><strong>Descrição</strong></td>
 <td data-label="Descrição">
 <span class="cell-val wrap">@Model?.Descricao</span>
 </td>
 </tr>
 <tr>
 <td data-label="Campo"><strong>Categoria</strong></td>
 <td data-label="Categoria"><span class="cell-val">@(Model.Categoria?.NomeCategoria ?? "-")</span></td>
 </tr>
 <tr>
 <td data-label="Campo"><strong>Prioridade</strong></td>
 <td data-label="Prioridade"><span class="cell-val">@(Model.Prioridade?.NomePrioridade ?? "-")</span></td>
 </tr>
 <tr>
 <td data-label="Campo"><strong>Data/Hora Abertura</strong></td>
 <td data-label="Data/Hora Abertura"><span class="cell-val">@(Model.DataAbertura?.ToLocalTime().ToString("g") ?? "-")</span></td>
 </tr>
 <tr>
 <td data-label="Campo"><strong>Técnico Responsável</strong></td>
 <td data-label="Técnico Responsável"><span class="cell-val">@(Model.TecnicoResponsavel?.NomeCompleto ?? "Não atribuído")</span></td>
 </tr>
 <tr>
 <td data-label="Campo"><strong>Previsão de Resolução (SLA)</strong></td>
 <td data-label="Previsão de Resolução (SLA)"><span class="cell-val">-</span></td>
 </tr>
 </tbody>
</table>
</section>

<section> @* Histórico de ações *@
<h3>Histórico de Atendimentos</h3>
<table class="table table-bordered w-100 stack-mobile limit-rows" data-limit="3">
<thead>
<tr>
<th>Data/Hora</th>
<th>Técnico</th>
<th>Ação</th>
</tr>
</thead>
<tbody>
@foreach(var a in Model.Atendimentos)
{
<tr>
<td data-label="Data/Hora"><span class="cell-val">@(a.DataAtendimento?.ToLocalTime().ToString("g") ?? "-")</span></td>
<td data-label="Técnico"><span class="cell-val">@(a.UsuarioTecnico?.NomeCompleto ?? "-")</span></td>
<td data-label="Ação"><span class="cell-val">@a.AcaoRealizada</span></td>
</tr>
}
</tbody>
</table>
</section>

<section> @* Mensagens trocadas *@
<h3>Comunicações</h3>
<div>
@foreach(var m in Model.Comunicacoes.OrderBy(c => c.DataEnvio))
{
<div class="db-msg-box">
<p><strong>@(m.Usuario?.NomeCompleto ?? "")</strong> - @(m.DataEnvio?.ToLocalTime().ToString("g") ?? "")</p>
<p>@m.Mensagem</p>
</div>
}
</div>

@if (TempData["SuccessMessage"] != null)
{
<div class="alert alert-success">@TempData["SuccessMessage"]</div>
}
@if (TempData["ErrorMessage"] != null)
{
<div class="alert alert-danger">@TempData["ErrorMessage"]</div>
}
</section>

<section> @* Anexos disponíveis *@
<h3>Anexos</h3>
<ul>
@foreach(var a in Model.Anexos)
{
<li><a asp-controller="Site" asp-action="DownloadAnexo" asp-route-id="@a.AnexoId">@a.NomeArquivo</a> (@(a.TipoArquivo ?? "-")) - @(a.DataUpload?.ToLocalTime().ToString("g") ?? "-")</li>
}
</ul>
</section>

<section> @* Envio de nova mensagem *@
<h3>Enviar Mensagem</h3>
<form method="post" asp-controller="Site" asp-action="EnviarMensagem">
<input type="hidden" name="chamado_id" value="@Model.ChamadoId" />
<label for="mensagem">Mensagem:</label><br />
<textarea id="mensagem" name="mensagem" rows="4" cols="80" placeholder="Digite sua mensagem..."></textarea><br /><br />
<button type="submit">Enviar Mensagem</button>
</form>
</section>
 </main>

 <div class="db-footer"> @* Rodapé *@
 <footer>
 <p>©2025 SoftForge - Todos os direitos reservados</p>
 </footer>
 </div>
</div>
</body>
</html>
