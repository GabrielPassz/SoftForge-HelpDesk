using System.IO;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Hosting;
using Microsoft.AspNetCore.Authorization;
using System.Collections.Generic;
using PIM_FINAL.Data;
using System.Threading.Tasks;
using Microsoft.EntityFrameworkCore;
using System.Security.Claims;
using Microsoft.AspNetCore.Authentication;
using Microsoft.AspNetCore.Authentication.Cookies;
using System;

namespace PIM_FINAL.Controllers
{
 public class SiteController : Controller
 {
 private readonly IWebHostEnvironment _env;
 private readonly PIMContext _db;

 public SiteController(IWebHostEnvironment env, PIMContext db)
 {
 _env = env;
 _db = db;
 }

 // Allow URLs like /Site or /Site/{viewName} or /Site/{viewName}/{id}
 [HttpGet]
 [AllowAnonymous]
 [Route("Site")]
 [Route("Site/{viewName}")]
 [Route("Site/{viewName}/{id}")]
 public IActionResult Page(string viewName = "InicialPainel", string id = null)
 {
 // sanitize viewName to avoid path traversal
 viewName = Path.GetFileName(viewName ?? string.Empty);
 if (string.IsNullOrEmpty(viewName))
 viewName = "InicialPainel";

 // pages that can be accessed without authentication
 var anonymousPages = new HashSet<string>(System.StringComparer.OrdinalIgnoreCase)
 {
 "Login",
 "Cadastro",
 "RegistroCadastro",
 "RecuperarSenha",
 "ValidarCodigoRedefinir"
 };

 // if user is not authenticated and the requested page is NOT in the anonymous list, redirect to login
 var isAuthenticated = User?.Identity?.IsAuthenticated ?? false;
 if (!isAuthenticated)
 {
 // User is not authenticated
 if (!anonymousPages.Contains(viewName))
 {
 return RedirectToAction("Page", new { viewName = "Login" });
 }
 }

 var viewPath = Path.Combine(_env.ContentRootPath, "Views", "site", viewName + ".cshtml");
 if (!System.IO.File.Exists(viewPath))
 {
 return NotFound();
 }

 // if an id was provided, add it to RouteData so views that read RouteData.Values["id"] work
 if (!string.IsNullOrEmpty(id))
 {
 RouteData.Values["id"] = id;
 }

 // expose id to ViewData/ViewBag to avoid nulls in views
 var idValue = id ?? (RouteData.Values.ContainsKey("id") ? RouteData.Values["id"]?.ToString() : null);
 if (!string.IsNullOrEmpty(idValue))
 {
 ViewData["id"] = idValue;
 ViewBag.Id = idValue;
 }

 return View($"~/Views/site/{viewName}.cshtml");
 }

 [HttpPost]
 [AllowAnonymous]
 [Route("Site/Login")]
 public async Task<IActionResult> Login(string usuario, string senha, string returnUrl = null)
 {
 // try to find user by email or name
 if (string.IsNullOrWhiteSpace(usuario))
 {
 // missing username
 return RedirectToAction("Page", new { viewName = "Login" });
 }

 var user = await _db.Usuarios.FirstOrDefaultAsync(u => u.Email == usuario || u.NomeCompleto == usuario);
 if (user == null)
 {
 // invalid user -> redirect back to login (could show message)
 return RedirectToAction("Page", new { viewName = "Login" });
 }

 // NOTE: no password stored in model. In a real app verify hashed password here.
 // Create claims
 var claims = new List<Claim>
 {
 new Claim(ClaimTypes.NameIdentifier, user.UsuarioId.ToString()),
 new Claim(ClaimTypes.Name, user.NomeCompleto ?? string.Empty),
 new Claim(ClaimTypes.Email, user.Email ?? string.Empty),
 };

 if (user.PerfilId.HasValue)
 {
 claims.Add(new Claim(ClaimTypes.Role, user.PerfilId.Value.ToString()));
 }

 var claimsIdentity = new ClaimsIdentity(claims, CookieAuthenticationDefaults.AuthenticationScheme);
 var principal = new ClaimsPrincipal(claimsIdentity);

 await HttpContext.SignInAsync(CookieAuthenticationDefaults.AuthenticationScheme, principal);

 // update last login
 user.UltimoLogin = DateTime.UtcNow;
 await _db.SaveChangesAsync();

 // redirect to returnUrl if local
 if (!string.IsNullOrEmpty(returnUrl) && Url.IsLocalUrl(returnUrl))
 {
 return Redirect(returnUrl);
 }

 return RedirectToAction("Page", new { viewName = "InicialPainel" });
 }

 [HttpPost]
 [Route("Site/Logout")]
 public async Task<IActionResult> Logout()
 {
 await HttpContext.SignOutAsync(CookieAuthenticationDefaults.AuthenticationScheme);
 return RedirectToAction("Page", new { viewName = "Login" });
 }
 }
}
