using System.IO;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Hosting;
using Microsoft.AspNetCore.Authorization;
using System.Collections.Generic;
using PIM_FINAL.Data;
using System.Threading.Tasks;
using Microsoft.EntityFrameworkCore;
using System.Security.Claims;
using Microsoft.AspNetCore.Authentication;
using Microsoft.AspNetCore.Authentication.Cookies;
using System;

namespace PIM_FINAL.Controllers
{
 public class SiteController : Controller
 {
 private readonly IWebHostEnvironment _env;
 private readonly PIMContext _db;

 public SiteController(IWebHostEnvironment env, PIMContext db)
 {
 _env = env;
 _db = db;
 }

 // Allow URLs like /Site or /Site/{viewName} or /Site/{viewName}/{id}
 [HttpGet]
 [AllowAnonymous]
 [Route("Site")]
 [Route("Site/{viewName}")]
 [Route("Site/{viewName}/{id}")]
 public IActionResult Page(string viewName = "InicialPainel", string id = null)
 {
 // sanitize viewName to avoid path traversal
 viewName = Path.GetFileName(viewName ?? string.Empty);
 if (string.IsNullOrEmpty(viewName))
 viewName = "InicialPainel";

 // pages that can be accessed without authentication
 var anonymousPages = new HashSet<string>(System.StringComparer.OrdinalIgnoreCase)
 {
 "Login",
 "Cadastro",
 "RegistroCadastro",
 "RecuperarSenha",
 "ValidarCodigoRedefinir"
 };

 // if user is not authenticated and the requested page is NOT in the anonymous list, redirect to login
 var isAuthenticated = User?.Identity?.IsAuthenticated ?? false;
 if (!isAuthenticated)
 {
 // User is not authenticated
 if (!anonymousPages.Contains(viewName))
 {
 return RedirectToAction("Page", new { viewName = "Login" });
 }
 }

 var viewPath = Path.Combine(_env.ContentRootPath, "Views", "site", viewName + ".cshtml");
 if (!System.IO.File.Exists(viewPath))
 {
 return NotFound();
 }

 // if an id was provided, add it to RouteData so views that read RouteData.Values["id"] work
 if (!string.IsNullOrEmpty(id))
 {
 RouteData.Values["id"] = id;
 }

 // expose id to ViewData/ViewBag to avoid nulls in views
 var idValue = id ?? (RouteData.Values.ContainsKey("id") ? RouteData.Values["id"]?.ToString() : null);
 if (!string.IsNullOrEmpty(idValue))
 {
 ViewData["id"] = idValue;
 ViewBag.Id = idValue;
 }

 return View($"~/Views/site/{viewName}.cshtml");
 }

 [HttpPost]
 [AllowAnonymous]
 [Route("Site/Login")]
 public async Task<IActionResult> Login(string usuario, string senha, string returnUrl = null)
 {
 // try to find user by email or name
 if (string.IsNullOrWhiteSpace(usuario))
 {
 // missing username
 return RedirectToAction("Page", new { viewName = "Login" });
 }

 var user = await _db.Usuarios.FirstOrDefaultAsync(u => u.Email == usuario || u.NomeCompleto == usuario);
 if (user == null)
 {
 // invalid user -> redirect back to login (could show message)
 return RedirectToAction("Page", new { viewName = "Login" });
 }

 // NOTE: no password stored in model. In a real app verify hashed password here.
 // Create claims
 var claims = new List<Claim>
 {
 new Claim(ClaimTypes.NameIdentifier, user.UsuarioId.ToString()),
 new Claim(ClaimTypes.Name, user.NomeCompleto ?? string.Empty),
 new Claim(ClaimTypes.Email, user.Email ?? string.Empty),
 };

 if (user.PerfilId.HasValue)
 {
 claims.Add(new Claim(ClaimTypes.Role, user.PerfilId.Value.ToString()));
 }

 var claimsIdentity = new ClaimsIdentity(claims, CookieAuthenticationDefaults.AuthenticationScheme);
 var principal = new ClaimsPrincipal(claimsIdentity);

 await HttpContext.SignInAsync(CookieAuthenticationDefaults.AuthenticationScheme, principal);

 // update last login
 user.UltimoLogin = DateTime.UtcNow;
 await _db.SaveChangesAsync();

 // redirect to returnUrl if local
 if (!string.IsNullOrEmpty(returnUrl) && Url.IsLocalUrl(returnUrl))
 {
 return Redirect(returnUrl);
 }

 return RedirectToAction("Page", new { viewName = "InicialPainel" });
 }

 [HttpPost]
 [Route("Site/Logout")]
 public async Task<IActionResult> Logout()
 {
 await HttpContext.SignOutAsync(CookieAuthenticationDefaults.AuthenticationScheme);
 return RedirectToAction("Page", new { viewName = "Login" });
 }

 // Registration: create a new Usuario as Solicitante (perfil_id =4)
 [HttpPost]
 [AllowAnonymous]
 [Route("Site/RegistroCadastro")]
 public async Task<IActionResult> RegistroCadastro(string nome, string email)
 {
 if (string.IsNullOrWhiteSpace(nome) || string.IsNullOrWhiteSpace(email))
 {
 return RedirectToAction("Page", new { viewName = "Cadastro" });
 }

 var existing = await _db.Usuarios.FirstOrDefaultAsync(u => u.Email == email);
 if (existing != null)
 {
 // user already exists
 return RedirectToAction("Page", new { viewName = "Cadastro" });
 }

 var user = new Models.Usuario
 {
 NomeCompleto = nome,
 Email = email,
 DataCadastro = DateTime.UtcNow,
 PerfilId =4 // Solicitante
 };

 _db.Usuarios.Add(user);
 await _db.SaveChangesAsync();

 // auto-login user (no password yet)
 var claims = new List<Claim>
 {
 new Claim(ClaimTypes.NameIdentifier, user.UsuarioId.ToString()),
 new Claim(ClaimTypes.Name, user.NomeCompleto ?? string.Empty),
 new Claim(ClaimTypes.Email, user.Email ?? string.Empty),
 new Claim(ClaimTypes.Role, user.PerfilId.Value.ToString())
 };
 var identity = new ClaimsIdentity(claims, CookieAuthenticationDefaults.AuthenticationScheme);
 await HttpContext.SignInAsync(CookieAuthenticationDefaults.AuthenticationScheme, new ClaimsPrincipal(identity));

 return RedirectToAction("Page", new { viewName = "InicialPainel" });
 }

 // Abrir Chamado (POST) - requires authenticated user
 [HttpPost]
 [Authorize]
 [Route("Site/AbrirChamado")]
 public async Task<IActionResult> AbrirChamado([FromForm] Models.Chamado chamado)
 {
 // set metadata
 chamado.DataAbertura = DateTime.UtcNow;

 // set solicitante from current user
 var userIdClaim = User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
 if (!int.TryParse(userIdClaim, out var userId))
 {
 return RedirectToAction("Page", new { viewName = "Login" });
 }
 chamado.UsuarioSolicitanteId = userId;

 // generate protocolo
 chamado.Protocolo = $"CHAM-{DateTime.UtcNow:yyyy}-{new Random().Next(100,999)}";

 _db.Chamados.Add(chamado);
 await _db.SaveChangesAsync();

 return RedirectToAction("MeusChamados");
 }

 // MeusChamados - list authenticated user's chamados
 [HttpGet]
 [Authorize]
 [Route("Site/MeusChamados")]
 public async Task<IActionResult> MeusChamados()
 {
 var userIdClaim = User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
 if (!int.TryParse(userIdClaim, out var userId))
 {
 return RedirectToAction("Page", new { viewName = "Login" });
 }

 var chamados = await _db.Chamados
 .Include(c => c.Prioridade)
 .Include(c => c.StatusChamado)
 .Include(c => c.Categoria)
 .Where(c => c.UsuarioSolicitanteId == userId)
 .OrderByDescending(c => c.DataAbertura)
 .ToListAsync();

 return View("~/Views/site/MeusChamados.cshtml", chamados);
 }

 // Detalhes do chamado do usuário
 [HttpGet]
 [Authorize]
 [Route("Site/DetalhesMeuChamado/{id}")]
 public async Task<IActionResult> DetalhesMeuChamado(int id)
 {
 var userIdClaim = User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
 if (!int.TryParse(userIdClaim, out var userId))
 {
 return RedirectToAction("Page", new { viewName = "Login" });
 }

 var chamado = await _db.Chamados
 .Include(c => c.Prioridade)
 .Include(c => c.StatusChamado)
 .Include(c => c.Categoria)
 .Include(c => c.Anexos)
 .Include(c => c.Comunicacoes)
 .FirstOrDefaultAsync(c => c.ChamadoId == id);

 if (chamado == null) return NotFound();
 if (chamado.UsuarioSolicitanteId != userId) return Forbid();

 return View("~/Views/site/DetalhesMeuChamado.cshtml", chamado);
 }
 }
}
