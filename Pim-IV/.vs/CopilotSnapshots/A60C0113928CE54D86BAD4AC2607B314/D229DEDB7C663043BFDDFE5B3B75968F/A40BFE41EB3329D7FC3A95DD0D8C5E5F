// Opt-in list/table limiter + stacked layout helpers
(function(){
 const DEFAULT_LIMIT =3; // default rows per table/list
 const DEFAULT_TABLE_COUNT_LIMIT =3; // default number of tables shown

 function readLimit(el){
 const attr = el.getAttribute && el.getAttribute('data-limit');
 const n = parseInt(attr,10);
 return Number.isFinite(n) && n >0 ? n : DEFAULT_LIMIT;
 }

 function readTableCountLimit(){
 const attr = document.body.getAttribute('data-max-tables');
 const n = parseInt(attr,10);
 return Number.isFinite(n) && n >0 ? n : DEFAULT_TABLE_COUNT_LIMIT;
 }

 function makeButton(text){
 const btn = document.createElement('button');
 btn.type = 'button';
 btn.className = 'btn btn-sm btn-secondary limit-toggle';
 btn.textContent = text || 'Mostrar mais';
 return btn;
 }

 /* Row limiting for lists */
 function applyToList(list){
 const limit = readLimit(list);
 const items = Array.from(list.children).filter(n => n.nodeType ===1);
 if(items.length <= limit) return;
 const hidden = items.slice(limit);
 hidden.forEach(li => li.style.display = 'none');
 const btn = makeButton('Mostrar mais');
 btn.addEventListener('click', () => {
 const expanded = hidden[0].style.display !== 'none';
 hidden.forEach(li => li.style.display = expanded ? 'none' : 'list-item');
 btn.textContent = expanded ? 'Mostrar mais' : 'Mostrar menos';
 });
 const wrap = document.createElement('div');
 wrap.appendChild(btn);
 list.parentNode.insertBefore(wrap, list.nextSibling);
 }

 /* Row limiting for tables */
 function applyToTable(table){
 const limit = readLimit(table);
 const tbodies = table.tBodies && table.tBodies.length ? Array.from(table.tBodies) : [table];
 const rows = tbodies.flatMap(tb => Array.from(tb.querySelectorAll('tr')));
 if(rows.length <= limit) return;
 const hidden = rows.slice(limit);
 hidden.forEach(r => r.style.display = 'none');
 const btn = makeButton('Mostrar mais');
 btn.addEventListener('click', () => {
 const expanded = hidden[0].style.display !== 'none';
 hidden.forEach(r => r.style.display = expanded ? 'none' : ''); // '' lets CSS decide (block vs table-row)
 btn.textContent = expanded ? 'Mostrar mais' : 'Mostrar menos';
 });
 const wrap = document.createElement('div');
 wrap.className = 'limit-wrap';
 wrap.style.marginTop = '4px';
 wrap.appendChild(btn);
 table.parentNode.insertBefore(wrap, table.nextSibling);
 }

 /* Table count limiting (show only first N tables with class .limit-table) */
 function applyTableCountLimit(){
 const limit = readTableCountLimit();
 const tables = Array.from(document.querySelectorAll('table.limit-table'));
 if(tables.length <= limit) return; // nothing to do
 const hidden = tables.slice(limit);
 hidden.forEach(t => {
 const sec = t.closest('.db-section') || t; // hide enclosing section if present
 sec.style.display = 'none';
 t.dataset._groupHidden = '1';
 });
 const btn = makeButton('Mostrar mais tabelas');
 btn.addEventListener('click', () => {
 const collapsed = hidden[0].closest('.db-section')?.style.display === 'none';
 hidden.forEach(t => {
 const sec = t.closest('.db-section') || t;
 sec.style.display = collapsed ? '' : 'none'; // '' restores default
 });
 btn.textContent = collapsed ? 'Mostrar menos tabelas' : 'Mostrar mais tabelas';
 });
 // Insert after the last initially visible table's section
 const anchorSec = tables[limit-1].closest('.db-section') || tables[limit-1];
 const wrap = document.createElement('div');
 wrap.className = 'limit-table-wrap';
 wrap.style.margin = '8px0';
 wrap.appendChild(btn);
 anchorSec.parentNode.insertBefore(wrap, anchorSec.nextSibling);
 }

 document.addEventListener('DOMContentLoaded', () => {
 // Row limits (opt-in with .limit-rows)
 document.querySelectorAll('ul.limit-rows:not(.no-limit), ol.limit-rows:not(.no-limit)').forEach(applyToList);
 document.querySelectorAll('table.limit-rows:not(.no-limit)').forEach(applyToTable);
 // Table count limit (opt-in per table with .limit-table)
 applyTableCountLimit();
 });
})();