using Microsoft.EntityFrameworkCore;
using PIM_FINAL.Models;

namespace PIM_FINAL.Data
{
    public class PIMContext : DbContext
    {
        public PIMContext(DbContextOptions<PIMContext> options) : base(options) { }

        public DbSet<Departamento> Departamentos { get; set; }
        public DbSet<Usuario> Usuarios { get; set; }
        public DbSet<PerfilUsuario> PerfisUsuario { get; set; }
        public DbSet<Funcionario> Funcionarios { get; set; }
        public DbSet<Categoria> Categorias { get; set; }
        public DbSet<Prioridade> Prioridades { get; set; }
        public DbSet<Sla> SLAs { get; set; }
        public DbSet<StatusChamado> StatusChamados { get; set; }
        public DbSet<BaseConhecimento> BasesConhecimento { get; set; }
        public DbSet<Chamado> Chamados { get; set; }
        public DbSet<Atendimento> Atendimentos { get; set; }
        public DbSet<Anexo> Anexos { get; set; }
        public DbSet<Avaliacao> Avaliacoes { get; set; }
        public DbSet<HistoricoChamado> HistoricosChamado { get; set; }
        public DbSet<LogAcesso> LogsAcesso { get; set; }
        public DbSet<IaAnalise> IAAnalises { get; set; }
        public DbSet<Comunicacao> Comunicacoes { get; set; }

        protected override void OnModelCreating(ModelBuilder modelBuilder)
        {
            // Usuario -> Departamento (many-to-one)
            modelBuilder.Entity<Usuario>()
                .HasOne(u => u.Departamento)
                .WithMany(d => d.Usuarios)
                .HasForeignKey(u => u.DepartamentoId)
                .OnDelete(DeleteBehavior.SetNull);

            // Usuario -> PerfilUsuario (many-to-one)
            modelBuilder.Entity<Usuario>()
                .HasOne(u => u.PerfilUsuario)
                .WithMany(p => p.Usuarios)
                .HasForeignKey(u => u.PerfilId)
                .OnDelete(DeleteBehavior.SetNull);

            // Funcionario -> Usuario (one-to-one, optional)
            modelBuilder.Entity<Funcionario>()
                .HasOne(f => f.Usuario)
                .WithOne()
                .HasForeignKey<Funcionario>(f => f.UsuarioId)
                .OnDelete(DeleteBehavior.SetNull);

            // BaseConhecimento -> Categoria (many-to-one)
            modelBuilder.Entity<BaseConhecimento>()
                .HasOne(b => b.Categoria)
                .WithMany(c => c.BaseConhecimentos)
                .HasForeignKey(b => b.CategoriaId)
                .OnDelete(DeleteBehavior.SetNull);

            // BaseConhecimento -> Usuario (criador)
            modelBuilder.Entity<BaseConhecimento>()
                .HasOne(b => b.UsuarioCriador)
                .WithMany(u => u.BaseConhecimentosCriados)
                .HasForeignKey(b => b.UsuarioCriadorId)
                .OnDelete(DeleteBehavior.SetNull);

            // Chamado -> Usuario (solicitante)
            modelBuilder.Entity<Chamado>()
                .HasOne(c => c.UsuarioSolicitante)
                .WithMany(u => u.ChamadosSolicitados)
                .HasForeignKey(c => c.UsuarioSolicitanteId)
                .OnDelete(DeleteBehavior.SetNull);

            // Chamado -> Usuario (técnico)
            modelBuilder.Entity<Chamado>()
                .HasOne(c => c.TecnicoResponsavel)
                .WithMany(u => u.ChamadosComoTecnico)
                .HasForeignKey(c => c.TecnicoResponsavelId)
                .OnDelete(DeleteBehavior.SetNull);

            // Chamado -> Categoria
            modelBuilder.Entity<Chamado>()
                .HasOne(c => c.Categoria)
                .WithMany(cat => cat.Chamados)
                .HasForeignKey(c => c.CategoriaId)
                .OnDelete(DeleteBehavior.SetNull);

            // Chamado -> Prioridade
            modelBuilder.Entity<Chamado>()
                .HasOne(c => c.Prioridade)
                .WithMany(p => p.Chamados)
                .HasForeignKey(c => c.PrioridadeId)
                .OnDelete(DeleteBehavior.SetNull);

            // Chamado -> StatusChamado
            modelBuilder.Entity<Chamado>()
                .HasOne(c => c.StatusChamado)
                .WithMany()
                .HasForeignKey(c => c.StatusId)
                .OnDelete(DeleteBehavior.SetNull);

            // Chamado -> Sla
            modelBuilder.Entity<Chamado>()
                .HasOne(c => c.Sla)
                .WithMany(s => s.Chamados)
                .HasForeignKey(c => c.SlaId)
                .OnDelete(DeleteBehavior.SetNull);

            // Atendimento -> Chamado
            modelBuilder.Entity<Atendimento>()
                .HasOne(a => a.Chamado)
                .WithMany(ch => ch.Atendimentos)
                .HasForeignKey(a => a.ChamadoId)
                .OnDelete(DeleteBehavior.Cascade);

            // Atendimento -> Usuario (técnico)
            modelBuilder.Entity<Atendimento>()
                .HasOne(a => a.UsuarioTecnico)
                .WithMany(u => u.AtendimentosTecnico)
                .HasForeignKey(a => a.UsuarioTecnicoId)
                .OnDelete(DeleteBehavior.SetNull);

            // Anexo -> Chamado
            modelBuilder.Entity<Anexo>()
                .HasOne(a => a.Chamado)
                .WithMany(ch => ch.Anexos)
                .HasForeignKey(a => a.ChamadoId)
                .OnDelete(DeleteBehavior.Cascade);

            // Anexo -> Usuario
            modelBuilder.Entity<Anexo>()
                .HasOne(a => a.Usuario)
                .WithMany(u => u.Anexos)
                .HasForeignKey(a => a.UsuarioId)
                .OnDelete(DeleteBehavior.SetNull);

            // Avaliacao -> Chamado (one-to-one)
            modelBuilder.Entity<Avaliacao>()
                .HasOne(a => a.Chamado)
                .WithOne(ch => ch.Avaliacao)
                .HasForeignKey<Avaliacao>(a => a.ChamadoId)
                .OnDelete(DeleteBehavior.Cascade);

            // Avaliacao -> Usuario (solicitante)
            modelBuilder.Entity<Avaliacao>()
                .HasOne(a => a.UsuarioSolicitante)
                .WithMany(u => u.AvaliacoesSolicitante)
                .HasForeignKey(a => a.UsuarioSolicitanteId)
                .OnDelete(DeleteBehavior.SetNull);

            // HistoricoChamado -> Chamado
            modelBuilder.Entity<HistoricoChamado>()
                .HasOne(h => h.Chamado)
                .WithMany(ch => ch.HistoricosChamado)
                .HasForeignKey(h => h.ChamadoId)
                .OnDelete(DeleteBehavior.Cascade);

            // HistoricoChamado -> Usuario
            modelBuilder.Entity<HistoricoChamado>()
                .HasOne(h => h.Usuario)
                .WithMany(u => u.HistoricosChamado)
                .HasForeignKey(h => h.UsuarioId)
                .OnDelete(DeleteBehavior.SetNull);

            // HistoricoChamado -> StatusChamado (anterior)
            modelBuilder.Entity<HistoricoChamado>()
                .HasOne(h => h.StatusAnterior)
                .WithMany()
                .HasForeignKey(h => h.StatusAnteriorId)
                .OnDelete(DeleteBehavior.SetNull);

            // HistoricoChamado -> StatusChamado (novo)
            modelBuilder.Entity<HistoricoChamado>()
                .HasOne(h => h.StatusNovo)
                .WithMany()
                .HasForeignKey(h => h.StatusNovoId)
                .OnDelete(DeleteBehavior.SetNull);

            // LogAcesso -> Usuario
            modelBuilder.Entity<LogAcesso>()
                .HasOne(l => l.Usuario)
                .WithMany(u => u.LogsAcesso)
                .HasForeignKey(l => l.UsuarioId)
                .OnDelete(DeleteBehavior.SetNull);

            // IaAnalise -> Chamado
            modelBuilder.Entity<IaAnalise>()
                .HasOne(ia => ia.Chamado)
                .WithMany(ch => ch.IAAnalises)
                .HasForeignKey(ia => ia.ChamadoId)
                .OnDelete(DeleteBehavior.Cascade);

            // Comunicacao -> Chamado
            modelBuilder.Entity<Comunicacao>()
                .HasOne(c => c.Chamado)
                .WithMany(ch => ch.Comunicacoes)
                .HasForeignKey(c => c.ChamadoId)
                .OnDelete(DeleteBehavior.Cascade);

            // Comunicacao -> Usuario
            modelBuilder.Entity<Comunicacao>()
                .HasOne(c => c.Usuario)
                .WithMany(u => u.Comunicacoes)
                .HasForeignKey(c => c.UsuarioId)
                .OnDelete(DeleteBehavior.SetNull);

            // Optional: enforce unique Avaliacao.ChamadoId
            modelBuilder.Entity<Avaliacao>()
                .HasIndex(a => a.ChamadoId)
                .IsUnique();

            base.OnModelCreating(modelBuilder);
        }
    }
}