// Please see documentation at https://learn.microsoft.com/aspnet/core/client-side/bundling-and-minification
// for details on configuring this project to bundle and minify static web assets.

// Global site script: list/table limiting + modal popup for long text + lightweight auto-refresh
(function(){
 function onReady(fn){ if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', fn); else fn(); }
 function makeButton(text, cls){ const b=document.createElement('button'); b.type='button'; b.className=cls||'btn btn-sm btn-secondary'; b.textContent=text||'Mostrar mais'; return b; }
 const DEFAULT_LIMIT=3, DEFAULT_TABLE_COUNT_LIMIT=3;
 function readLimit(el){ const n=parseInt(el.getAttribute('data-limit'),10); return Number.isFinite(n)&&n>0?n:DEFAULT_LIMIT; }
 function readTableCountLimit(){ const n=parseInt(document.body.getAttribute('data-max-tables'),10); return Number.isFinite(n)&&n>0?n:DEFAULT_TABLE_COUNT_LIMIT; }

 // --- Limiters ---
 function applyToList(list){ const limit=readLimit(list); const items=[...list.children].filter(n=>n.nodeType===1); if(items.length<=limit) return; const hidden=items.slice(limit); hidden.forEach(li=>li.classList.add('is-hidden')); const btn=makeButton('Mostrar mais','btn btn-sm btn-secondary limit-toggle'); btn.addEventListener('click',()=>{ const expanded=hidden[0].classList.contains('is-hidden')===false; hidden.forEach(li=>li.classList.toggle('is-hidden',expanded)); btn.textContent=expanded?'Mostrar mais':'Mostrar menos';}); const wrap=document.createElement('div'); wrap.appendChild(btn); list.parentNode.insertBefore(wrap,list.nextSibling); }
 function applyToTable(table){ const limit=readLimit(table); const tbodies=table.tBodies&&table.tBodies.length?[...table.tBodies]:[table]; const rows=tbodies.flatMap(tb=>[...tb.querySelectorAll('tr')]); if(rows.length<=limit) return; const hidden=rows.slice(limit); hidden.forEach(r=>r.classList.add('is-hidden')); const btn=makeButton('Mostrar mais','btn btn-sm btn-secondary limit-toggle'); btn.addEventListener('click',()=>{ const expanded=hidden[0].classList.contains('is-hidden')===false; hidden.forEach(r=>r.classList.toggle('is-hidden',expanded)); btn.textContent=expanded?'Mostrar mais':'Mostrar menos';}); const wrap=document.createElement('div'); wrap.className='limit-wrap'; wrap.style.marginTop='4px'; wrap.appendChild(btn); table.parentNode.insertBefore(wrap,table.nextSibling); }
 function applyTableCountLimit(){ const limit=readTableCountLimit(); const tables=[...document.querySelectorAll('table.limit-table')]; if(tables.length<=limit) return; const hiddenSections=tables.slice(limit).map(t=>t.closest('.db-section')||t).filter(Boolean); hiddenSections.forEach(sec=>sec.classList.add('is-hidden')); const btn=makeButton('Mostrar mais tabelas','btn btn-sm btn-secondary limit-toggle'); btn.addEventListener('click',()=>{ const collapsed=hiddenSections[0].classList.contains('is-hidden')===false; hiddenSections.forEach(sec=>sec.classList.toggle('is-hidden',collapsed)); btn.textContent=collapsed?'Mostrar mais tabelas':'Mostrar menos tabelas';}); const anchor=tables[limit-1].closest('.db-section')||tables[limit-1]; const wrap=document.createElement('div'); wrap.className='limit-table-wrap'; wrap.style.margin='8px0'; wrap.appendChild(btn); anchor.parentNode.insertBefore(wrap,anchor.nextSibling); }

 // --- Modal show-full ---
 function ensureModal(){ let o=document.getElementById('sf-modal'); if(o) return o; o=document.createElement('div'); o.id='sf-modal'; o.className='sf-modal-overlay'; o.hidden=true; o.innerHTML='<div class="sf-modal" role="dialog" aria-modal="true" aria-labelledby="sf-modal-title">\
<header><h3 id="sf-modal-title">Detalhe</h3><button type="button" class="close-btn" data-dismiss>Fechar</button></header>\
<div id="sf-modal-body"></div></div>'; document.body.appendChild(o); return o; }
 function wireModal(){ const o=ensureModal(); const body=o.querySelector('#sf-modal-body'); const title=o.querySelector('#sf-modal-title'); function close(){ o.hidden=true; body.textContent=''; } o.addEventListener('click',e=>{ if(e.target===o||e.target.hasAttribute('data-dismiss')) close(); }); document.addEventListener('click',e=>{ const btn=e.target.closest('.js-show-full'); if(!btn) return; title.textContent=btn.getAttribute('data-title')||'Detalhe'; body.textContent=btn.getAttribute('data-content')||''; o.hidden=false; }); }
 function isOverflowing(el){ return el && el.scrollWidth>el.clientWidth; }
 function addShowFullButtons(){ const rows=[...document.querySelectorAll('table tr')]; rows.forEach(tr=>{ const tds=tr.querySelectorAll('td'); if(tds.length<2) return; const first=(tds[0].innerText||'').trim().toLowerCase(); const isDesc=first.startsWith('descri')||tds[1].getAttribute('data-label')==='Descrição'; if(!isDesc) return; const val=tds[1].querySelector('.cell-val')||tds[1]; const text=(val.textContent||'').trim(); if(!text) return; const long=text.length>100||isOverflowing(val); if(long && !tds[1].querySelector('.js-show-full')){ const btn=makeButton('Ver completo','cell-more js-show-full'); btn.setAttribute('data-title','Descrição'); btn.setAttribute('data-content',text); val.insertAdjacentElement('afterend',btn); } }); }

 // --- Auto refresh via lightweight version endpoint ---
 let lastVer=null; let lastCheck=0; const CHECK_MS=15000; //15s
 async function checkVersion(){ try{ const r=await fetch('/api/activity-version',{cache:'no-store'}); if(!r.ok) return; const j=await r.json(); if(lastVer!==null && j.ver!==lastVer){ console.log('Atualizações detectadas, recarregando...'); location.reload(); } lastVer=j.ver; }catch(e){} }
 function scheduleChecks(){ const now=Date.now(); if(now-lastCheck>CHECK_MS){ lastCheck=now; checkVersion(); } setTimeout(scheduleChecks, CHECK_MS); }

 onReady(()=>{
 if(!document.getElementById('limitlists-hidden-style')){ const s=document.createElement('style'); s.id='limitlists-hidden-style'; s.textContent='.is-hidden{display:none !important}'; document.head.appendChild(s); }
 document.querySelectorAll('ul.limit-rows:not(.no-limit), ol.limit-rows:not(.no-limit)').forEach(applyToList);
 document.querySelectorAll('table.limit-rows:not(.no-limit)').forEach(applyToTable);
 applyTableCountLimit();
 wireModal();
 addShowFullButtons();
 window.addEventListener('resize',()=>{ clearTimeout(window.__rT); window.__rT=setTimeout(addShowFullButtons,150); });
 scheduleChecks();
 });
})();
