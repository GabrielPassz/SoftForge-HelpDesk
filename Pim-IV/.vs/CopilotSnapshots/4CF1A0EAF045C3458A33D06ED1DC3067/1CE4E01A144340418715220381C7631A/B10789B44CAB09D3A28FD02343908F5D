// Opt-in list/table limiter + stacked layout helpers (no inline display mutations)
(function () {
    const DEFAULT_LIMIT = 3; // default rows per table/list
    const DEFAULT_TABLE_COUNT_LIMIT = 3; // default number of tables shown when using .limit-table

    function readLimit(el) {
        const attr = el.getAttribute && el.getAttribute('data-limit');
        const n = parseInt(attr, 10);
        return Number.isFinite(n) && n > 0 ? n : DEFAULT_LIMIT;
    }
    function readTableCountLimit() {
        const attr = document.body.getAttribute('data-max-tables');
        const n = parseInt(attr, 10);
        return Number.isFinite(n) && n > 0 ? n : DEFAULT_TABLE_COUNT_LIMIT;
    }
    function makeButton(text) {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'btn btn-sm btn-secondary limit-toggle';
        btn.textContent = text || 'Mostrar mais';
        return btn;
    }

    // Row limiting for lists (uses .is-hidden class)
    function applyToList(list) {
        const limit = readLimit(list);
        const items = Array.from(list.children).filter(n => n.nodeType === 1);
        if (items.length <= limit) return;
        const hidden = items.slice(limit);
        hidden.forEach(li => li.classList.add('is-hidden'));
        const btn = makeButton('Mostrar mais');
        btn.addEventListener('click', () => {
            const expanded = hidden[0].classList.contains('is-hidden') === false;
            hidden.forEach(li => li.classList.toggle('is-hidden', expanded));
            btn.textContent = expanded ? 'Mostrar mais' : 'Mostrar menos';
        });
        const wrap = document.createElement('div');
        wrap.appendChild(btn);
        list.parentNode.insertBefore(wrap, list.nextSibling);
    }

    // Row limiting for tables (uses .is-hidden on <tr>)
    function applyToTable(table) {
        const limit = readLimit(table);
        const tbodies = table.tBodies && table.tBodies.length ? Array.from(table.tBodies) : [table];
        const rows = tbodies.flatMap(tb => Array.from(tb.querySelectorAll('tr')));
        if (rows.length <= limit) return;
        const hidden = rows.slice(limit);
        hidden.forEach(r => r.classList.add('is-hidden'));
        const btn = makeButton('Mostrar mais');
        btn.addEventListener('click', () => {
            const expanded = hidden[0].classList.contains('is-hidden') === false;
            hidden.forEach(r => r.classList.toggle('is-hidden', expanded));
            btn.textContent = expanded ? 'Mostrar mais' : 'Mostrar menos';
        });
        const wrap = document.createElement('div');
        wrap.className = 'limit-wrap';
        wrap.style.marginTop = '4px';
        wrap.appendChild(btn);
        table.parentNode.insertBefore(wrap, table.nextSibling);
    }

    // Table count limiting (opt-in with .limit-table)
    function applyTableCountLimit() {
        const limit = readTableCountLimit();
        const tables = Array.from(document.querySelectorAll('table.limit-table'));
        if (tables.length <= limit) return;
        const hiddenSections = tables.slice(limit)
            .map(t => t.closest('.db-section') || t)
            .filter(Boolean);
        hiddenSections.forEach(sec => sec.classList.add('is-hidden'));
        const btn = makeButton('Mostrar mais tabelas');
        btn.addEventListener('click', () => {
            const collapsed = hiddenSections[0].classList.contains('is-hidden') === false;
            hiddenSections.forEach(sec => sec.classList.toggle('is-hidden', collapsed));
            btn.textContent = collapsed ? 'Mostrar mais tabelas' : 'Mostrar menos tabelas';
        });
        const anchorSec = (tables[limit - 1].closest('.db-section') || tables[limit - 1]);
        const wrap = document.createElement('div');
        wrap.className = 'limit-table-wrap';
        wrap.style.margin = '8px0';
        wrap.appendChild(btn);
        anchorSec.parentNode.insertBefore(wrap, anchorSec.nextSibling);
    }

    document.addEventListener('DOMContentLoaded', () => {
        // Add global CSS rule for .is-hidden if not present
        const styleId = 'limitlists-hidden-style';
        if (!document.getElementById(styleId)) {
            const style = document.createElement('style');
            style.id = styleId;
            style.textContent = '.is-hidden{display:none !important}';
            document.head.appendChild(style);
        }
        // Row limits (opt-in with .limit-rows)
        document.querySelectorAll('ul.limit-rows:not(.no-limit), ol.limit-rows:not(.no-limit)')
            .forEach(applyToList);
        document.querySelectorAll('table.limit-rows:not(.no-limit)')
            .forEach(applyToTable);
        // Table count limit
        applyTableCountLimit();
    });
})();