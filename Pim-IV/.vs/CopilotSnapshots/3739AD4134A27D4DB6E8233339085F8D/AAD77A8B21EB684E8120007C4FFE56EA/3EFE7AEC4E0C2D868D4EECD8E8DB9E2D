using System.IO;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Hosting;
using Microsoft.AspNetCore.Authorization;
using System.Collections.Generic;
using PIM_FINAL.Data;
using System.Threading.Tasks;
using Microsoft.EntityFrameworkCore;
using System.Security.Claims;
using Microsoft.AspNetCore.Authentication;
using Microsoft.AspNetCore.Authentication.Cookies;
using System;
using PIM_FINAL.Models;
using Microsoft.AspNetCore.Identity;
using Microsoft.Extensions.Configuration;
using System.Net.Mail;
using Microsoft.AspNetCore.Http;
using System.Linq;

namespace PIM_FINAL.Controllers
{
    public class SiteController : Controller
    {
        private readonly IWebHostEnvironment _env;
        private readonly PIMContext _db;
        private readonly IConfiguration _config;
        private const long MaxUploadBytes = 5 * 1024 * 1024; //5MB
        private static readonly string[] AllowedExtensions = new[] { ".png", ".jpg", ".jpeg", ".gif", ".pdf", ".txt", ".log", ".doc", ".docx" };

        public SiteController(IWebHostEnvironment env, PIMContext db, IConfiguration config)
        {
            _env = env;
            _db = db;
            _config = config;

            // ensure uploads folder exists
            var uploadsDir = Path.Combine(_env.WebRootPath ?? Path.Combine(Directory.GetCurrentDirectory(), "wwwroot"), "uploads");
            if (!Directory.Exists(uploadsDir)) Directory.CreateDirectory(uploadsDir);
        }

        // Allow URLs like /Site or /Site/{viewName} or /Site/{viewName}/{id}
        [HttpGet]
        [AllowAnonymous]
        [Route("Site")]
        [Route("Site/{viewName}")]
        [Route("Site/{viewName}/{id}")]
        public IActionResult Page(string viewName = "InicialPainel", string id = null)
        {
            // sanitize viewName to avoid path traversal
            viewName = Path.GetFileName(viewName ?? string.Empty);
            if (string.IsNullOrEmpty(viewName))
                viewName = "InicialPainel";

            // pages that can be accessed without authentication
            var anonymousPages = new HashSet<string>(System.StringComparer.OrdinalIgnoreCase)
 {
 "Login",
 "Cadastro",
 "RegistroCadastro",
 "RecuperarSenha",
 "ValidarCodigoRedefinir"
 };

            // if user is not authenticated and the requested page is NOT in the anonymous list, redirect to login
            var isAuthenticated = User?.Identity?.IsAuthenticated ?? false;
            if (!isAuthenticated && !anonymousPages.Contains(viewName))
            {
                return RedirectToAction("Page", new { viewName = "Login" });
            }

            var viewPath = Path.Combine(_env.ContentRootPath, "Views", "site", viewName + ".cshtml");
            if (!System.IO.File.Exists(viewPath))
            {
                return NotFound();
            }

            // if an id was provided, add it to RouteData so views that read RouteData.Values["id"] work
            if (!string.IsNullOrEmpty(id))
            {
                RouteData.Values["id"] = id;
            }

            // expose id to ViewData/ViewBag to avoid nulls in views
            var idValue = id ?? (RouteData.Values.ContainsKey("id") ? RouteData.Values["id"]?.ToString() : null);
            if (!string.IsNullOrEmpty(idValue))
            {
                ViewData["id"] = idValue;
                ViewBag.Id = idValue;
            }

            return View($"~/Views/site/{viewName}.cshtml");
        }

        [HttpPost]
        [AllowAnonymous]
        [Route("Site/Login")]
        public async Task<IActionResult> Login(string usuario, string senha, string returnUrl = null)
        {
            if (string.IsNullOrWhiteSpace(usuario) || string.IsNullOrWhiteSpace(senha))
            {
                return RedirectToAction("Page", new { viewName = "Login" });
            }

            var user = await _db.Usuarios.FirstOrDefaultAsync(u => u.Email == usuario || u.NomeCompleto == usuario);
            if (user == null)
            {
                return RedirectToAction("Page", new { viewName = "Login" });
            }

            var hasher = new PasswordHasher<Usuario>();
            var verify = hasher.VerifyHashedPassword(user, user.Senha ?? string.Empty, senha);
            if (verify == PasswordVerificationResult.Failed)
            {
                // Migration path: if stored password equals provided plaintext, hash it now and continue
                if (!string.IsNullOrEmpty(user.Senha) && user.Senha == senha)
                {
                    user.Senha = hasher.HashPassword(user, senha);
                    user.UltimoLogin = DateTime.UtcNow;
                    await _db.SaveChangesAsync();
                    // treat as successful
                }
                else
                {
                    return RedirectToAction("Page", new { viewName = "Login" });
                }
            }

            // Create claims
            var claims = new List<Claim>
 {
 new Claim(ClaimTypes.NameIdentifier, user.UsuarioId.ToString()),
 new Claim(ClaimTypes.Name, user.NomeCompleto ?? string.Empty),
 new Claim(ClaimTypes.Email, user.Email ?? string.Empty),
 };

            if (user.PerfilId.HasValue)
            {
                claims.Add(new Claim(ClaimTypes.Role, user.PerfilId.Value.ToString()));
            }

            var claimsIdentity = new ClaimsIdentity(claims, CookieAuthenticationDefaults.AuthenticationScheme);
            var principal = new ClaimsPrincipal(claimsIdentity);

            await HttpContext.SignInAsync(CookieAuthenticationDefaults.AuthenticationScheme, principal);

            // update last login
            user.UltimoLogin = DateTime.UtcNow;
            await _db.SaveChangesAsync();

            // redirect to returnUrl if local
            if (!string.IsNullOrEmpty(returnUrl) && Url.IsLocalUrl(returnUrl))
            {
                return Redirect(returnUrl);
            }

            return RedirectToAction("Page", new { viewName = "InicialPainel" });
        }

        [HttpPost]
        [Route("Site/Logout")]
        public async Task<IActionResult> Logout()
        {
            await HttpContext.SignOutAsync(CookieAuthenticationDefaults.AuthenticationScheme);
            return RedirectToAction("Page", new { viewName = "Login" });
        }

        // Registration: create a new Usuario as Solicitante (perfil_id =4)
        [HttpPost]
        [AllowAnonymous]
        [Route("Site/RegistroCadastro")]
        public async Task<IActionResult> RegistroCadastro(string nome, string email, string senha)
        {
            if (string.IsNullOrWhiteSpace(nome) || string.IsNullOrWhiteSpace(email) || string.IsNullOrWhiteSpace(senha))
            {
                return RedirectToAction("Page", new { viewName = "Cadastro" });
            }

            var existing = await _db.Usuarios.FirstOrDefaultAsync(u => u.Email == email);
            if (existing != null)
            {
                // user already exists
                return RedirectToAction("Page", new { viewName = "Cadastro" });
            }

            var user = new Models.Usuario
            {
                NomeCompleto = nome,
                Email = email,
                DataCadastro = DateTime.UtcNow,
                PerfilId = 4 // Solicitante
            };

            // hash senha and store in 'senha' column
            var hasher = new PasswordHasher<Usuario>();
            user.Senha = hasher.HashPassword(user, senha);

            _db.Usuarios.Add(user);
            await _db.SaveChangesAsync();

            // auto-login user
            var claims = new List<Claim>
 {
 new Claim(ClaimTypes.NameIdentifier, user.UsuarioId.ToString()),
 new Claim(ClaimTypes.Name, user.NomeCompleto ?? string.Empty),
 new Claim(ClaimTypes.Email, user.Email ?? string.Empty),
 new Claim(ClaimTypes.Role, user.PerfilId.Value.ToString())
 };
            var identity = new ClaimsIdentity(claims, CookieAuthenticationDefaults.AuthenticationScheme);
            await HttpContext.SignInAsync(CookieAuthenticationDefaults.AuthenticationScheme, new ClaimsPrincipal(identity));

            return RedirectToAction("Page", new { viewName = "InicialPainel" });
        }

        // Abrir Chamado - GET
        [HttpGet]
        [Authorize]
        [Route("Site/AbrirChamado")]
        public async Task<IActionResult> AbrirChamado()
        {
            var userIdClaim = User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
            if (!int.TryParse(userIdClaim, out var userId)) return RedirectToAction("Page", new { viewName = "Login" });

            var user = await _db.Usuarios.FirstOrDefaultAsync(u => u.UsuarioId == userId);
            var model = new Models.AbrirChamado
            {
                SolicitanteNome = user?.NomeCompleto ?? string.Empty,
                SolicitanteDepartamento = user?.Departamento?.NomeDepartamento ?? string.Empty
            };

            var categorias = await _db.Categorias.OrderBy(c => c.NomeCategoria).ToListAsync();
            model.CategoriasSelect = categorias.Select(c => new Microsoft.AspNetCore.Mvc.Rendering.SelectListItem(c.NomeCategoria, c.CategoriaId.ToString())).ToList();
            var prioridades = await _db.Prioridades.OrderBy(p => p.NomePrioridade).ToListAsync();
            model.PrioridadesSelect = prioridades.Select(p => new Microsoft.AspNetCore.Mvc.Rendering.SelectListItem(p.NomePrioridade, p.PrioridadeId.ToString())).ToList();

            return View("~/Views/site/AbrirChamado.cshtml", model);
        }

        // Abrir Chamado - POST
        [HttpPost]
        [Authorize]
        [Route("Site/AbrirChamado")]
        public async Task<IActionResult> AbrirChamado([FromForm] Models.Chamado chamado, IFormFile? AnexoFile)
        {
            // set metadata
            chamado.DataAbertura = DateTime.UtcNow;

            // set solicitante from current user
            var userIdClaim = User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
            if (!int.TryParse(userIdClaim, out var userId))
            {
                return RedirectToAction("Page", new { viewName = "Login" });
            }
            chamado.UsuarioSolicitanteId = userId;

            // generate protocolo
            chamado.Protocolo = $"CHAM-{DateTime.UtcNow:yyyy}-{new Random().Next(100,999)}";

            // add chamado
            _db.Chamados.Add(chamado);
            await _db.SaveChangesAsync();

            TempData["SuccessMessage"] = $"Chamado criado: {chamado.Protocolo}";

            // handle attachment if provided
            if (AnexoFile != null && AnexoFile.Length > 0)
            {
                try
                {
                    var uploadsDir = Path.Combine(_env.WebRootPath ?? Path.Combine(Directory.GetCurrentDirectory(), "wwwroot"), "uploads");
                    if (!Directory.Exists(uploadsDir)) Directory.CreateDirectory(uploadsDir);

                    var uniqueFileName = $"{Guid.NewGuid():N}_{Path.GetFileName(AnexoFile.FileName)}";
                    var filePath = Path.Combine(uploadsDir, uniqueFileName);

                    using (var stream = System.IO.File.Create(filePath))
                    {
                        await AnexoFile.CopyToAsync(stream);
                    }

                    var anexo = new Anexo
                    {
                        ChamadoId = chamado.ChamadoId,
                        NomeArquivo = AnexoFile.FileName,
                        TipoArquivo = AnexoFile.ContentType,
                        CaminhoArquivo = "/uploads/" + uniqueFileName,
                        DataUpload = DateTime.UtcNow,
                        UsuarioId = userId
                    };
                    _db.Anexos.Add(anexo);
                    await _db.SaveChangesAsync();
                    TempData["SuccessMessage"] = "Anexo enviado com sucesso.";
                }
                catch
                {
                    // ignore attachment errors for now
                }
            }

            // try notify user by email (if configured)
            try { await SendNotificationEmailAsync((await _db.Usuarios.FindAsync(chamado.UsuarioSolicitanteId))?.Email, "Seu chamado foi criado", $"Seu chamado {chamado.Protocolo} foi criado."); } catch { }

            return RedirectToAction("MeusChamados");
        }

        // MeusChamados - list authenticated user's chamados
        [HttpGet]
        [Authorize]
        [Route("Site/MeusChamados")]
        public async Task<IActionResult> MeusChamados()
        {
            var userIdClaim = User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
            if (!int.TryParse(userIdClaim, out var userId))
            {
                return RedirectToAction("Page", new { viewName = "Login" });
            }

            var chamados = await _db.Chamados
            .Include(c => c.Prioridade)
            .Include(c => c.StatusChamado)
            .Include(c => c.Categoria)
            .Where(c => c.UsuarioSolicitanteId == userId)
            .OrderByDescending(c => c.DataAbertura)
            .ToListAsync();

            return View("~/Views/site/MeusChamados.cshtml", chamados);
        }

        // Detalhes do chamado do usuário
        [HttpGet]
        [Authorize]
        [Route("Site/DetalhesMeuChamado/{id}")]
        public async Task<IActionResult> DetalhesMeuChamado(int id)
        {
            var userIdClaim = User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
            if (!int.TryParse(userIdClaim, out var userId))
            {
                return RedirectToAction("Page", new { viewName = "Login" });
            }

            var chamado = await _db.Chamados
            .Include(c => c.Prioridade)
            .Include(c => c.StatusChamado)
            .Include(c => c.Categoria)
            .Include(c => c.Anexos)
            .Include(c => c.Comunicacoes)
            .FirstOrDefaultAsync(c => c.ChamadoId == id);

            if (chamado == null) return NotFound();
            if (chamado.UsuarioSolicitanteId != userId) return Forbid();

            return View("~/Views/site/DetalhesMeuChamado.cshtml", chamado);
        }

        // Technician/manager/admin view of a chamado
        [HttpGet]
        [Authorize]
        [Route("Site/DetalhesChamado/{id}")]
        public async Task<IActionResult> DetalhesChamado(int id)
        {
            var userIdClaim = User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
            if (!int.TryParse(userIdClaim, out var userId))
            {
                return RedirectToAction("Page", new { viewName = "Login" });
            }

            var chamado = await _db.Chamados
            .Include(c => c.Prioridade)
            .Include(c => c.StatusChamado)
            .Include(c => c.Categoria)
            .Include(c => c.Anexos)
            .Include(c => c.Comunicacoes).ThenInclude(cm => cm.Usuario)
            .Include(c => c.Atendimentos).ThenInclude(a => a.UsuarioTecnico)
            .Include(c => c.UsuarioSolicitante)
            .Include(c => c.TecnicoResponsavel)
            .FirstOrDefaultAsync(c => c.ChamadoId == id);

            if (chamado == null) return NotFound();

            // permit: assigned technician, manager/admin (roles1,2), any technician (3) or the owner
            var role = User.FindFirst(ClaimTypes.Role)?.Value;
            bool isTecnico = role == "3" || role == "2" || role == "1";
            if (chamado.TecnicoResponsavelId != userId && !isTecnico && chamado.UsuarioSolicitanteId != userId)
            {
                return Forbid();
            }

            return View("~/Views/site/DetalhesChamado.cshtml", chamado);
        }

        // Detalhes de escalonamento - show called details in escalonamento context
        [HttpGet]
        [Authorize]
        [Route("Site/DetalhesEscalonamento/{id}")]
        public async Task<IActionResult> DetalhesEscalonamento(int id)
        {
            var chamado = await _db.Chamados
            .Include(c => c.Prioridade)
            .Include(c => c.StatusChamado)
            .Include(c => c.Categoria)
            .Include(c => c.Anexos)
            .Include(c => c.Comunicacoes).ThenInclude(cm => cm.Usuario)
            .Include(c => c.Atendimentos).ThenInclude(a => a.UsuarioTecnico)
            .Include(c => c.UsuarioSolicitante)
            .Include(c => c.TecnicoResponsavel)
            .FirstOrDefaultAsync(c => c.ChamadoId == id);

            if (chamado == null) return NotFound();

            return View("~/Views/site/DetalhesEscalonamento.cshtml", chamado);
        }

        // Dashboard Gestor - basic KPIs
        [HttpGet]
        [Authorize(Roles = "2,1")]
        [Route("Site/DashboardGestor")]
        public async Task<IActionResult> DashboardGestor()
        {
            var total = await _db.Chamados.CountAsync();
            var resolved = await _db.Chamados.CountAsync(c => c.DataFechamento != null);
            var open = await _db.Chamados.CountAsync(c => c.DataFechamento == null);
            var criticalOpen = await _db.Chamados.CountAsync(c => c.Prioridade != null && c.Prioridade.NomePrioridade != null && EF.Functions.ILike(c.Prioridade.NomePrioridade, "%crit%") && c.DataFechamento == null);

            ViewBag.TotalChamados = total;
            ViewBag.ChamadosResolvidos = resolved;
            ViewBag.ChamadosAbertos = open;
            ViewBag.ChamadosCriticosAbertos = criticalOpen;

            return View("~/Views/site/DashboardGestor.cshtml");
        }

        [HttpPost]
        [Authorize(Roles = "2,1")]
        [Route("exportar-dashboard")]
        public IActionResult ExportarDashboard(string formato)
        {
            TempData["SuccessMessage"] = $"Exportação iniciada (formato: {formato}).";
            return RedirectToAction("DashboardGestor");
        }

        // Gerar relatório (accepts posted filters)
        [HttpPost]
        [Authorize(Roles = "2,1")]
        [Route("Site/GerarRelatorio")]
        public IActionResult GerarRelatorio()
        {
            TempData["SuccessMessage"] = "Relatório gerado com sucesso (visualização temporária).";
            return RedirectToAction("Page", new { viewName = "Relatorios" });
        }

        // Configuration POST endpoints (admin)
        [HttpPost]
        [Authorize(Roles = "1")]
        [Route("adicionar-departamento")]
        public async Task<IActionResult> AdicionarDepartamento(string nome_departamento, string descricao_departamento)
        {
            if (string.IsNullOrWhiteSpace(nome_departamento)) { TempData["ErrorMessage"] = "Nome obrigatório."; return RedirectToAction("Page", new { viewName = "Configuracao" }); }
            var d = new Departamento { NomeDepartamento = nome_departamento, Descricao = descricao_departamento };
            _db.Departamentos.Add(d);
            await _db.SaveChangesAsync();
            TempData["SuccessMessage"] = "Departamento adicionado.";
            return RedirectToAction("Page", new { viewName = "Configuracao" });
        }

        [HttpPost]
        [Authorize(Roles = "1")]
        [Route("adicionar-categoria")]
        public async Task<IActionResult> AdicionarCategoria(string nome_categoria, string descricao_categoria)
        {
            if (string.IsNullOrWhiteSpace(nome_categoria)) { TempData["ErrorMessage"] = "Nome obrigatório."; return RedirectToAction("Page", new { viewName = "Configuracao" }); }
            var c = new Categoria { NomeCategoria = nome_categoria, Descricao = descricao_categoria };
            _db.Categorias.Add(c);
            await _db.SaveChangesAsync();
            TempData["SuccessMessage"] = "Categoria adicionada.";
            return RedirectToAction("Page", new { viewName = "Configuracao" });
        }

        [HttpPost]
        [Authorize(Roles = "1")]
        [Route("adicionar-prioridade")]
        public async Task<IActionResult> AdicionarPrioridade(string nome_prioridade, string descricao_prioridade)
        {
            if (string.IsNullOrWhiteSpace(nome_prioridade)) { TempData["ErrorMessage"] = "Nome obrigatório."; return RedirectToAction("Page", new { viewName = "Configuracao" }); }
            var p = new Prioridade { NomePrioridade = nome_prioridade, Descricao = descricao_prioridade };
            _db.Prioridades.Add(p);
            await _db.SaveChangesAsync();
            TempData["SuccessMessage"] = "Prioridade adicionada.";
            return RedirectToAction("Page", new { viewName = "Configuracao" });
        }

        [HttpPost]
        [Authorize(Roles = "1")]
        [Route("editar-sla")]
        public async Task<IActionResult> EditarSla(string sla_prioridade, int tempo_primeira_resposta, int tempo_resolucao)
        {
            if (string.IsNullOrWhiteSpace(sla_prioridade)) { TempData["ErrorMessage"] = "Prioridade obrigatória."; return RedirectToAction("Page", new { viewName = "Configuracao" }); }
            var prioridade = await _db.Prioridades.FirstOrDefaultAsync(p => EF.Functions.ILike(p.NomePrioridade, $"%{sla_prioridade}%"));
            if (prioridade == null) { TempData["ErrorMessage"] = "Prioridade não encontrada."; return RedirectToAction("Page", new { viewName = "Configuracao" }); }
            var sla = await _db.SLAs.FirstOrDefaultAsync(s => s.PrioridadeId == prioridade.PrioridadeId);
            if (sla == null)
            {
                sla = new Sla { NomeSla = prioridade.NomePrioridade, PrioridadeId = prioridade.PrioridadeId, TempoPrimeiraResposta = tempo_primeira_resposta, TempoMaximoResolucao = tempo_resolucao };
                _db.SLAs.Add(sla);
            }
            else
            {
                sla.TempoPrimeiraResposta = tempo_primeira_resposta;
                sla.TempoMaximoResolucao = tempo_resolucao;
            }
            await _db.SaveChangesAsync();
            TempData["SuccessMessage"] = "SLA atualizado.";
            return RedirectToAction("Page", new { viewName = "Configuracao" });
        }

        [HttpPost]
        [Authorize(Roles = "1")]
        [Route("adicionar-status")]
        public async Task<IActionResult> AdicionarStatus(string nome_status, string descricao_status)
        {
            if (string.IsNullOrWhiteSpace(nome_status)) { TempData["ErrorMessage"] = "Nome obrigatório."; return RedirectToAction("Page", new { viewName = "Configuracao" }); }
            var s = new StatusChamado { NomeStatus = nome_status, Descricao = descricao_status };
            _db.StatusChamados.Add(s);
            await _db.SaveChangesAsync();
            TempData["SuccessMessage"] = "Status adicionado.";
            return RedirectToAction("Page", new { viewName = "Configuracao" });
        }

        [HttpPost]
        [Authorize(Roles = "1")]
        [Route("adicionar-perfil")]
        public async Task<IActionResult> AdicionarPerfil(string nome_perfil, string descricao_perfil)
        {
            if (string.IsNullOrWhiteSpace(nome_perfil)) { TempData["ErrorMessage"] = "Nome obrigatório."; return RedirectToAction("Page", new { viewName = "Configuracao" }); }
            var p = new PerfilUsuario { NomePerfil = nome_perfil, Descricao = descricao_perfil };
            _db.PerfisUsuario.Add(p);
            await _db.SaveChangesAsync();
            TempData["SuccessMessage"] = "Perfil adicionado.";
            return RedirectToAction("Page", new { viewName = "Configuracao" });
        }

        private async Task SendNotificationEmailAsync(string? to, string subject, string body)
        {
            if (string.IsNullOrWhiteSpace(to)) return;
            var smtpHost = _config["Smtp:Host"];
            if (string.IsNullOrWhiteSpace(smtpHost)) return; // no smtp configured

            try
            {
                var port = int.TryParse(_config["Smtp:Port"], out var p) ? p : 25;
                var user = _config["Smtp:User"];
                var pass = _config["Smtp:Pass"];
                using var msg = new MailMessage();
                msg.To.Add(new MailAddress(to));
                msg.From = new MailAddress(_config["Smtp:From"] ?? "noreply@example.com");
                msg.Subject = subject;
                msg.Body = body;
                using var client = new SmtpClient(smtpHost, port);
                if (!string.IsNullOrEmpty(user)) client.Credentials = new System.Net.NetworkCredential(user, pass);
                client.EnableSsl = bool.TryParse(_config["Smtp:EnableSsl"], out var ssl) && ssl;
                await client.SendMailAsync(msg);
            }
            catch
            {
                // ignore email errors
            }
        }
    }
}
