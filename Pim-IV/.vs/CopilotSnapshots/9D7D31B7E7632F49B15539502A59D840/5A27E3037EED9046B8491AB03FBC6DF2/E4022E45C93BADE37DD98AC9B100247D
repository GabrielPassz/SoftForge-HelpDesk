using Supabase; // Cliente Supabase
using Microsoft.EntityFrameworkCore; // EF Core
using PIM_FINAL.Data; // DbContext
using Microsoft.AspNetCore.Authentication.Cookies; // Cookies
using Microsoft.AspNetCore.Authorization; // Políticas
using PIM_FINAL.Services; // Serviços (IA)
using Microsoft.AspNetCore.StaticFiles; // Arquivos estáticos
using Microsoft.AspNetCore.Mvc.Razor; // Razor runtime compilation
using Microsoft.AspNetCore.Mvc; // MVC base

// Program: configura DI, autenticação/autorização, MVC e pipeline HTTP. Mantido sem alterações de lógica.
var builder = WebApplication.CreateBuilder(args);

// Supabase Client (singleton) - utiliza variáveis de ambiente/config
builder.Services.AddSingleton<Supabase.Client>(sp =>
{
 var url = Environment.GetEnvironmentVariable("SUPABASE_URL") ?? builder.Configuration["SUPABASE_URL"];
 var key = Environment.GetEnvironmentVariable("SUPABASE_KEY") ?? builder.Configuration["SUPABASE_KEY"];
 var options = new Supabase.SupabaseOptions { AutoConnectRealtime = true };
 var client = new Supabase.Client(url, key, options);
 client.InitializeAsync().GetAwaiter().GetResult();
 return client;
});

// DbContext (PostgreSQL via Npgsql)
builder.Services.AddDbContext<PIMContext>(options =>
 options.UseNpgsql(builder.Configuration["SUPABASE_DB_CONNECTION"]));

// Autenticação Cookie
builder.Services.AddAuthentication(CookieAuthenticationDefaults.AuthenticationScheme)
 .AddCookie(options =>
 {
 options.LoginPath = "/site/Login";
 options.AccessDeniedPath = "/site/Login";
 });

// Autorização (fallback exige usuário autenticado)
builder.Services.AddAuthorization(options =>
{
 options.FallbackPolicy = new AuthorizationPolicyBuilder()
 .RequireAuthenticatedUser()
 .Build();
});

// MVC + Razor runtime compilation em DEBUG
var mvcBuilder = builder.Services.AddControllersWithViews();
#if DEBUG
try { mvcBuilder.AddRazorRuntimeCompilation(); } catch { }
#endif

// Serviços auxiliares
builder.Services.AddHttpClient();
builder.Services.AddSingleton<IAiService, RapidAiService>();

var app = builder.Build();

// Erros e segurança
if (!app.Environment.IsDevelopment())
{
 app.UseExceptionHandler("/Home/Error");
 app.UseHsts();
}

app.UseHttpsRedirection();

// Arquivos estáticos (no dev: desabilita cache)
if (app.Environment.IsDevelopment())
{
 app.UseStaticFiles(new StaticFileOptions
 {
 OnPrepareResponse = ctx =>
 {
 ctx.Context.Response.Headers["Cache-Control"] = "no-cache, no-store, must-revalidate";
 ctx.Context.Response.Headers["Pragma"] = "no-cache";
 ctx.Context.Response.Headers["Expires"] = "0";
 }
 });
 app.Use(async (context, next) =>
 {
 context.Response.Headers["Cache-Control"] = "no-store";
 context.Response.Headers["Pragma"] = "no-cache";
 context.Response.Headers["Expires"] = "0";
 await next();
 });
}
else
{
 app.UseStaticFiles();
}

app.UseRouting();
app.UseAuthentication();
app.UseAuthorization();

// Rota padrão: Site/Page com viewName=Login
app.MapControllerRoute(
 name: "default",
 pattern: "{controller=Site}/{action=Page}/{viewName=Login}/{id?}");

app.Run();