// Lightweight SW (v7): no caching, always network-first
const SW_VERSION = 'v7';

self.addEventListener('install', event => {
    // Activate new SW immediately
    self.skipWaiting();
});

self.addEventListener('activate', event => {
    // Clear all caches from any previous versions and take control
    event.waitUntil((async () => {
        try {
            const keys = await caches.keys();
            await Promise.all(keys.map(k => caches.delete(k)));
        } catch {}
        await self.clients.claim();
    })());
});

function isAuth(url) {
    try {
        const path = new URL(url).pathname.toLowerCase();
        return path.includes('/site/login') || path.includes('/site/logout') || path.includes('/site/registrocadastro');
    } catch { return false; }
}

self.addEventListener('fetch', event => {
    const req = event.request;

    // Never intercept non-GET
    if (req.method !== 'GET') { event.respondWith(fetch(req)); return; }

    // HTML navigations: always fresh
    if (req.mode === 'navigate') {
        event.respondWith(fetch(req, { cache: 'no-store', credentials: 'same-origin' }));
        return;
    }

    // Auth endpoints: never cache
    if (isAuth(req.url)) {
        event.respondWith(fetch(req, { cache: 'no-store', credentials: 'same-origin' }));
        return;
    }

    const url = new URL(req.url);
    const isCssJs = url.pathname.endsWith('.css') || url.pathname.endsWith('.js');

    // CSS/JS: bypass cache fully
    if (isCssJs) {
        event.respondWith(fetch(req, { cache: 'no-store' }));
        return;
    }

    // Default: direct network
    event.respondWith(fetch(req));
});
