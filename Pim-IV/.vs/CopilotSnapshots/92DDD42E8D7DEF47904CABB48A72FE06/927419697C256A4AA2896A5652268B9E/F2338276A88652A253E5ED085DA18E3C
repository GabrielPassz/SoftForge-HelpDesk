using System.IO;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Hosting;
using Microsoft.AspNetCore.Authorization;
using System.Collections.Generic;
using PIM_FINAL.Data;
using System.Threading.Tasks;
using Microsoft.EntityFrameworkCore;
using System.Security.Claims;
using Microsoft.AspNetCore.Authentication;
using Microsoft.AspNetCore.Authentication.Cookies;
using System;
using PIM_FINAL.Models;
using Microsoft.AspNetCore.Identity;
using Microsoft.Extensions.Configuration;
using System.Net.Mail;
using Microsoft.AspNetCore.Http;
using System.Linq;
using System.Text;
using PIM_FINAL.Services; // AI service

namespace PIM_FINAL.Controllers
{
    public class SiteController : Controller
    {
        private readonly IWebHostEnvironment _env;
        private readonly PIMContext _db;
        private readonly IConfiguration _config;
        private readonly IAiService _ai; // injected AI
        private const long MaxUploadBytes = 5 * 1024 * 1024; //5MB
        private static readonly string[] AllowedExtensions = new[] { ".png", ".jpg", ".jpeg", ".gif", ".pdf", ".txt", ".log", ".doc", ".docx" };

        public SiteController(IWebHostEnvironment env, PIMContext db, IConfiguration config, IAiService ai)
        {
            _env = env;
            _db = db;
            _config = config;
            _ai = ai;

            // ensure uploads folder exists
            var uploadsDir = Path.Combine(_env.WebRootPath ?? Path.Combine(Directory.GetCurrentDirectory(), "wwwroot"), "uploads");
            if (!Directory.Exists(uploadsDir)) Directory.CreateDirectory(uploadsDir);
        }

        // Allow URLs like /Site or /Site/{viewName} or /Site/{viewName}/{id}
        [HttpGet]
        [AllowAnonymous]
        [Route("Site")]
        [Route("Site/{viewName}")]
        [Route("Site/{viewName}/{id}")]
        public IActionResult Page(string viewName = "InicialPainel", string id = null)
        {
            // sanitize viewName to avoid path traversal
            viewName = Path.GetFileName(viewName ?? string.Empty);
            if (string.IsNullOrEmpty(viewName))
                viewName = "InicialPainel";

            // pages that can be accessed without authentication
            var anonymousPages = new HashSet<string>(System.StringComparer.OrdinalIgnoreCase)
 {
 "Login",
 "Cadastro",
 "RegistroCadastro",
 "RecuperarSenha",
 "ValidarCodigoRedefinir"
 };

            // if user is not authenticated and the requested page is NOT in the anonymous list, redirect to login
            var isAuthenticated = User?.Identity?.IsAuthenticated ?? false;
            if (!isAuthenticated && !anonymousPages.Contains(viewName))
            {
                return RedirectToAction("Page", new { viewName = "Login" });
            }

            // If requesting the inicial panel, redirect to the action that builds its viewmodel
            if (string.Equals(viewName, "InicialPainel", StringComparison.OrdinalIgnoreCase))
            {
                // If already inside InicialPainel action avoid redirect loop
                var currentAction = (string)RouteData.Values["action"] ?? string.Empty;
                if (!string.Equals(currentAction, "InicialPainel", StringComparison.OrdinalIgnoreCase))
                {
                    return RedirectToAction("InicialPainel");
                }
            }

            var viewPath = Path.Combine(_env.ContentRootPath, "Views", "site", viewName + ".cshtml");
            if (!System.IO.File.Exists(viewPath))
            {
                return NotFound();
            }

            // if an id was provided, add it to RouteData so views that read RouteData.Values["id"] work
            if (!string.IsNullOrEmpty(id))
            {
                RouteData.Values["id"] = id;
            }

            // expose id to ViewData/ViewBag to avoid nulls in views
            var idValue = id ?? (RouteData.Values.ContainsKey("id") ? RouteData.Values["id"]?.ToString() : null);
            if (!string.IsNullOrEmpty(idValue))
            {
                ViewData["id"] = idValue;
                ViewBag.Id = idValue;
            }

            // Special handling: strongly typed view requiring model
            if (string.Equals(viewName, "EditarUsuario", StringComparison.OrdinalIgnoreCase))
            {
                // Only admin (PerfilId1) allowed via this shortcut
                var roleClaim = User.FindFirst(ClaimTypes.Role)?.Value;
                if (roleClaim != "1") return Forbid();
                var currentIdStr = User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
                if (!int.TryParse(currentIdStr, out var currentId)) return RedirectToAction("Page", new { viewName = "Login" });
                var userEntity = _db.Usuarios.Include(u=>u.Departamento).Include(u=>u.PerfilUsuario).FirstOrDefault(u=>u.UsuarioId==currentId);
                if (userEntity == null) return NotFound();
                var perfis = _db.PerfisUsuario.OrderBy(p=>p.NomePerfil).ToList();
                var deps = _db.Departamentos.OrderBy(d=>d.NomeDepartamento).ToList();
                var vm = new EditUsuarioViewModel
                {
                    UsuarioId = userEntity.UsuarioId,
                    NomeCompleto = userEntity.NomeCompleto,
                    Email = userEntity.Email,
                    PerfilId = userEntity.PerfilId,
                    DepartamentoId = userEntity.DepartamentoId,
                    Perfis = perfis.Select(p=> new Microsoft.AspNetCore.Mvc.Rendering.SelectListItem(p.NomePerfil, p.PerfilId.ToString())).ToList(),
                    Departamentos = deps.Select(d=> new Microsoft.AspNetCore.Mvc.Rendering.SelectListItem(d.NomeDepartamento, d.DepartamentoId.ToString())).ToList()
                };
                return View("~/Views/site/EditarUsuario.cshtml", vm);
            }

            return View($"~/Views/site/{viewName}.cshtml");
        }

        [HttpPost]
        [AllowAnonymous]
        [Route("Site/Login")]
        public async Task<IActionResult> Login(string usuario, string senha, string returnUrl = null)
        {
            if (string.IsNullOrWhiteSpace(usuario) || string.IsNullOrWhiteSpace(senha))
            {
                TempData["ErrorMessage"] = "Informe usuário e senha.";
                return RedirectToAction("Page", new { viewName = "Login" });
            }

            var user = await _db.Usuarios.FirstOrDefaultAsync(u => u.Email == usuario || u.NomeCompleto == usuario);
            if (user == null)
            {
                TempData["ErrorMessage"] = "Usuário ou senha inválidos.";
                return RedirectToAction("Page", new { viewName = "Login" });
            }

            var hasher = new PasswordHasher<Usuario>();
            var verify = hasher.VerifyHashedPassword(user, user.Senha ?? string.Empty, senha);
            if (verify == PasswordVerificationResult.Failed)
            {
                // Migração: se senha armazenada for texto puro igual à informada, hashear agora e seguir
                if (!string.IsNullOrEmpty(user.Senha) && user.Senha == senha)
                {
                    user.Senha = hasher.HashPassword(user, senha);
                    await _db.SaveChangesAsync();
                }
                else
                {
                    TempData["ErrorMessage"] = "Usuário ou senha inválidos.";
                    return RedirectToAction("Page", new { viewName = "Login" });
                }
            }

            // Bloqueia usuários pendentes (sem perfil definido)
            if (!user.PerfilId.HasValue)
            {
                TempData["ErrorMessage"] = "Sua conta ainda aguarda aprovação do administrador.";
                return RedirectToAction("Page", new { viewName = "Login" });
            }

            // Claims e login
            var claims = new List<Claim>
 {
 new Claim(ClaimTypes.NameIdentifier, user.UsuarioId.ToString()),
 new Claim(ClaimTypes.Name, user.NomeCompleto ?? string.Empty),
 new Claim(ClaimTypes.Email, user.Email ?? string.Empty),
 new Claim(ClaimTypes.Role, user.PerfilId.Value.ToString())
 };

            var claimsIdentity = new ClaimsIdentity(claims, CookieAuthenticationDefaults.AuthenticationScheme);
            var principal = new ClaimsPrincipal(claimsIdentity);
            await HttpContext.SignInAsync(CookieAuthenticationDefaults.AuthenticationScheme, principal);

            user.UltimoLogin = DateTime.UtcNow;
            await _db.SaveChangesAsync();

            // redirect to returnUrl if local
            if (!string.IsNullOrEmpty(returnUrl) && Url.IsLocalUrl(returnUrl))
            {
                return Redirect(returnUrl);
            }

            return RedirectToAction("Page", new { viewName = "InicialPainel" });
        }

        [HttpPost]
        [Route("Site/Logout")]
        public async Task<IActionResult> Logout()
        {
            await HttpContext.SignOutAsync(CookieAuthenticationDefaults.AuthenticationScheme);
            return RedirectToAction("Page", new { viewName = "Login" });
        }

        // Registration: create pending user (requires admin approval)
        [HttpPost]
        [AllowAnonymous]
        [Route("Site/RegistroCadastro")]
        public async Task<IActionResult> RegistroCadastro(string nome, string email, string senha)
        {
            if (string.IsNullOrWhiteSpace(nome) || string.IsNullOrWhiteSpace(email) || string.IsNullOrWhiteSpace(senha))
            {
                TempData["ErrorMessage"] = "Preencha todos os campos.";
                return RedirectToAction("Page", new { viewName = "Cadastro" });
            }

            var existing = await _db.Usuarios.FirstOrDefaultAsync(u => u.Email == email);
            if (existing != null)
            {
                TempData["ErrorMessage"] = "E-mail já cadastrado.";
                return RedirectToAction("Page", new { viewName = "Cadastro" });
            }

            var user = new Usuario
            {
                NomeCompleto = nome,
                Email = email,
                DataCadastro = DateTime.UtcNow,
                PerfilId = null // pendente até aprovação
            };

            var hasher = new PasswordHasher<Usuario>();
            user.Senha = hasher.HashPassword(user, senha);

            _db.Usuarios.Add(user);
            await _db.SaveChangesAsync();

            TempData["SuccessMessage"] = "Solicitação enviada. Aguarde aprovação do administrador.";
            return RedirectToAction("Page", new { viewName = "Login" });
        }

        // Abrir Chamado - GET
        [HttpGet]
        [Authorize]
        [Route("Site/AbrirChamado")]
        public async Task<IActionResult> AbrirChamado()
        {
            var userIdClaim = User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
            if (!int.TryParse(userIdClaim, out var userId)) return RedirectToAction("Page", new { viewName = "Login" });

            var user = await _db.Usuarios.FirstOrDefaultAsync(u => u.UsuarioId == userId);
            var model = new Models.AbrirChamado
            {
                SolicitanteNome = user?.NomeCompleto ?? string.Empty,
                SolicitanteDepartamento = user?.Departamento?.NomeDepartamento ?? string.Empty
            };

            var categorias = await _db.Categorias.OrderBy(c => c.NomeCategoria).ToListAsync();
            model.CategoriasSelect = categorias.Select(c => new Microsoft.AspNetCore.Mvc.Rendering.SelectListItem(c.NomeCategoria, c.CategoriaId.ToString())).ToList();
            var prioridades = await _db.Prioridades.OrderBy(p => p.NomePrioridade).ToListAsync();
            model.PrioridadesSelect = prioridades.Select(p => new Microsoft.AspNetCore.Mvc.Rendering.SelectListItem(p.NomePrioridade, p.PrioridadeId.ToString())).ToList();

            return View("~/Views/site/AbrirChamado.cshtml", model);
        }

        // Abrir Chamado - POST (com IA)
        [HttpPost]
        [Authorize]
        [Route("Site/AbrirChamado")]
        public async Task<IActionResult> AbrirChamado([FromForm] Models.Chamado chamado, IFormFile? AnexoFile)
        {
            chamado.DataAbertura = DateTime.UtcNow;
            var userIdClaim = User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
            if (!int.TryParse(userIdClaim, out var userId)) return RedirectToAction("Page", new { viewName = "Login" });
            chamado.UsuarioSolicitanteId = userId;
            chamado.Protocolo = $"CHAM-{DateTime.UtcNow:yyyy}-{new Random().Next(100,999)}";

            // IA: obter listas para classificação
            var categorias = await _db.Categorias.OrderBy(c => c.NomeCategoria).Select(c => c.NomeCategoria).ToListAsync();
            var prioridades = await _db.Prioridades.OrderBy(p => p.NomePrioridade).Select(p => p.NomePrioridade).ToListAsync();
            string cat = string.Empty, pri = string.Empty, just = string.Empty;
            try
            {
                var classification = await _ai.ClassifyAsync(chamado.Titulo ?? string.Empty, chamado.Descricao ?? string.Empty, categorias, prioridades);
                cat = classification.Categoria; pri = classification.Prioridade; just = classification.Justificativa;
                if (!string.IsNullOrWhiteSpace(cat))
                {
                    var c = await _db.Categorias.FirstOrDefaultAsync(x => x.NomeCategoria == cat);
                    if (c != null) chamado.CategoriaId = c.CategoriaId;
                }
                if (!string.IsNullOrWhiteSpace(pri))
                {
                    var p = await _db.Prioridades.FirstOrDefaultAsync(x => x.NomePrioridade == pri);
                    if (p != null) chamado.PrioridadeId = p.PrioridadeId;
                }
            }
            catch { }

            _db.Chamados.Add(chamado);
            await _db.SaveChangesAsync();

            // Registrar análise IA se houver justificativa
            if (!string.IsNullOrWhiteSpace(cat) || !string.IsNullOrWhiteSpace(just))
            {
                try
                {
                    var analise = new IaAnalise
                    {
                        ChamadoId = chamado.ChamadoId,
                        CategoriaPrevista = string.IsNullOrWhiteSpace(cat)? null : cat,
                        Comentario = string.IsNullOrWhiteSpace(just)? null : just,
                        DataAnalise = DateTime.UtcNow
                    };
                    _db.Add(analise);
                    await _db.SaveChangesAsync();
                }
                catch { }
            }

            // IA resposta inicial
            try
            {
                var reply = await _ai.SuggestInitialReplyAsync(chamado.Titulo ?? string.Empty, chamado.Descricao ?? string.Empty);
                if (!string.IsNullOrWhiteSpace(reply))
                {
                    var comunicacao = new Comunicacao
                    {
                        ChamadoId = chamado.ChamadoId,
                        UsuarioId = userId,
                        Mensagem = "[IA] " + reply,
                        DataEnvio = DateTime.UtcNow
                    };
                    _db.Comunicacoes.Add(comunicacao);
                    await _db.SaveChangesAsync();
                }
            }
            catch { }

            TempData["SuccessMessage"] = $"Chamado criado: {chamado.Protocolo}";

            if (AnexoFile != null && AnexoFile.Length >0)
            {
                try
                {
                    var uploadsDir = Path.Combine(_env.WebRootPath ?? Path.Combine(Directory.GetCurrentDirectory(), "wwwroot"), "uploads");
                    if (!Directory.Exists(uploadsDir)) Directory.CreateDirectory(uploadsDir);
                    var uniqueFileName = $"{Guid.NewGuid():N}_{Path.GetFileName(AnexoFile.FileName)}";
                    var filePath = Path.Combine(uploadsDir, uniqueFileName);
                    using (var stream = System.IO.File.Create(filePath))
                        await AnexoFile.CopyToAsync(stream);
                    var anexo = new Anexo
                    {
                        ChamadoId = chamado.ChamadoId,
                        NomeArquivo = AnexoFile.FileName,
                        TipoArquivo = AnexoFile.ContentType,
                        CaminhoArquivo = "/uploads/" + uniqueFileName,
                        DataUpload = DateTime.UtcNow,
                        UsuarioId = userId
                    };
                    _db.Anexos.Add(anexo);
                    await _db.SaveChangesAsync();
                }
                catch { }
            }

            try { await SendNotificationEmailAsync((await _db.Usuarios.FindAsync(chamado.UsuarioSolicitanteId))?.Email, "Seu chamado foi criado", $"Seu chamado {chamado.Protocolo} foi criado."); } catch { }
            return RedirectToAction("MeusChamados");
        }

        // MeusChamados - list authenticated user's chamados
        [HttpGet]
        [Authorize]
        [Route("Site/MeusChamados")]
        public async Task<IActionResult> MeusChamados()
        {
            var userIdClaim = User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
            if (!int.TryParse(userIdClaim, out var userId))
            {
                return RedirectToAction("Page", new { viewName = "Login" });
            }

            var chamados = await _db.Chamados
            .Include(c => c.Prioridade)
            .Include(c => c.StatusChamado)
            .Include(c => c.Categoria)
            .Where(c => c.UsuarioSolicitanteId == userId)
            .OrderByDescending(c => c.DataAbertura)
            .ToListAsync();

            return View("~/Views/site/MeusChamados.cshtml", chamados);
        }

        // Detalhes do chamado do usuário
        [HttpGet]
        [Authorize]
        [Route("Site/DetalhesMeuChamado/{id}")]
        public async Task<IActionResult> DetalhesMeuChamado(int id)
        {
            var userIdClaim = User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
            if (!int.TryParse(userIdClaim, out var userId))
            {
                return RedirectToAction("Page", new { viewName = "Login" });
            }

            var chamado = await _db.Chamados
            .Include(c => c.Prioridade)
            .Include(c => c.StatusChamado)
            .Include(c => c.Categoria)
            .Include(c => c.Anexos)
            .Include(c => c.Comunicacoes)
            .FirstOrDefaultAsync(c => c.ChamadoId == id);

            if (chamado == null) return NotFound();
            if (chamado.UsuarioSolicitanteId != userId) return Forbid();

            return View("~/Views/site/DetalhesMeuChamado.cshtml", chamado);
        }

        // Technician/manager/admin view of a chamado
        [HttpGet]
        [Authorize]
        [Route("Site/DetalhesChamado/{id}")]
        public async Task<IActionResult> DetalhesChamado(int id)
        {
            var userIdClaim = User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
            if (!int.TryParse(userIdClaim, out var userId))
            {
                return RedirectToAction("Page", new { viewName = "Login" });
            }

            var chamado = await _db.Chamados
            .Include(c => c.Prioridade)
            .Include(c => c.StatusChamado)
            .Include(c => c.Categoria)
            .Include(c => c.Anexos)
            .Include(c => c.Comunicacoes).ThenInclude(cm => cm.Usuario)
            .Include(c => c.Atendimentos).ThenInclude(a => a.UsuarioTecnico)
            .Include(c => c.UsuarioSolicitante)
            .Include(c => c.TecnicoResponsavel)
            .FirstOrDefaultAsync(c => c.ChamadoId == id);

            if (chamado == null) return NotFound();

            // permit: assigned technician, manager/admin (roles1,2), any technician (3) or the owner
            var role = User.FindFirst(ClaimTypes.Role)?.Value;
            bool isTecnico = role == "3" || role == "2" || role == "1";
            if (chamado.TecnicoResponsavelId != userId && !isTecnico && chamado.UsuarioSolicitanteId != userId)
            {
                return Forbid();
            }

            return View("~/Views/site/DetalhesChamado.cshtml", chamado);
        }

        // Escalonamento: manual form POST from Escalonamento.cshtml
        [HttpPost]
        [Authorize]
        [Route("Site/Escalonamento")]
        public async Task<IActionResult> Escalonamento(string protocolo, string motivo, string novo_tecnico, string nova_prioridade)
        {
            if (string.IsNullOrWhiteSpace(protocolo))
            {
                TempData["ErrorMessage"] = "Protocolo é obrigatório.";
                return RedirectToAction("Page", new { viewName = "Escalonamento" });
            }

            var chamado = await _db.Chamados.FirstOrDefaultAsync(c => c.Protocolo == protocolo || c.Protocolo == protocolo.TrimStart('#'));
            if (chamado == null)
            {
                TempData["ErrorMessage"] = "Chamado não encontrado.";
                return RedirectToAction("Page", new { viewName = "Escalonamento" });
            }

            var userIdClaim = User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
            if (!int.TryParse(userIdClaim, out var userId)) return RedirectToAction("Page", new { viewName = "Login" });

            // resolve technician by id or name
            if (!string.IsNullOrWhiteSpace(novo_tecnico))
            {
                if (int.TryParse(novo_tecnico, out var parsed)) chamado.TecnicoResponsavelId = parsed;
                else
                {
                    var u = await _db.Usuarios.FirstOrDefaultAsync(x => x.NomeCompleto != null && EF.Functions.ILike(x.NomeCompleto, $"%{novo_tecnico}%"));
                    if (u != null) chamado.TecnicoResponsavelId = u.UsuarioId;
                }
            }

            if (!string.IsNullOrWhiteSpace(nova_prioridade))
            {
                var p = await _db.Prioridades.FirstOrDefaultAsync(x => x.NomePrioridade != null && EF.Functions.ILike(x.NomePrioridade, $"%{nova_prioridade}%"));
                if (p != null) chamado.PrioridadeId = p.PrioridadeId;
            }

            var comunicacao = new Comunicacao
            {
                ChamadoId = chamado.ChamadoId,
                UsuarioId = userId,
                Mensagem = $"Escalonamento manual: {motivo}",
                DataEnvio = DateTime.UtcNow
            };
            _db.Comunicacoes.Add(comunicacao);
            await _db.SaveChangesAsync();

            TempData["SuccessMessage"] = "Escalonamento realizado.";
            return RedirectToAction("Page", new { viewName = "DetalhesEscalonamento", id = chamado.ChamadoId });
        }

        // Atendimento: list for technician (or manager/admin see more)
        [HttpGet]
        [Authorize]
        [Route("Site/Atendimento")]
        [Route("Atendimento")]
        public async Task<IActionResult> Atendimento()
        {
            var userIdClaim = User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
            if (!int.TryParse(userIdClaim, out var userId)) return RedirectToAction("Page", new { viewName = "Login" });
            var role = User.FindFirst(ClaimTypes.Role)?.Value;
            bool isTecnico = role == "3" || role == "2" || role == "1"; // tecnico, gestor, admin

            if (!isTecnico) return Forbid();

            var chamados = await _db.Chamados
            .Include(c => c.Prioridade)
            .Include(c => c.StatusChamado)
            .Include(c => c.Categoria)
            .Where(c => c.TecnicoResponsavelId == userId || c.TecnicoResponsavelId == null)
            .OrderByDescending(c => c.DataAbertura)
            .ToListAsync();

            return View("~/Views/site/Atendimento.cshtml", chamados);
        }

        // Start atendimento: assign tecnico and create Atendimento record
        [HttpPost]
        [Authorize]
        [Route("Site/IniciarAtendimento")]
        [Route("iniciar-atendimento")]
        public async Task<IActionResult> IniciarAtendimento(int chamado_id)
        {
            var userIdClaim = User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
            if (!int.TryParse(userIdClaim, out var userId)) return RedirectToAction("Page", new { viewName = "Login" });
            var chamado = await _db.Chamados.FirstOrDefaultAsync(c => c.ChamadoId == chamado_id);
            if (chamado == null) return NotFound();

            chamado.TecnicoResponsavelId = userId;
            // try to set status to "Em Atendimento" if exists
            var status = await _db.StatusChamados.FirstOrDefaultAsync(s => EF.Functions.ILike(s.NomeStatus, "%atendimento%"));
            if (status != null) chamado.StatusId = status.StatusId;

            var atendimento = new Atendimento
            {
                ChamadoId = chamado.ChamadoId,
                UsuarioTecnicoId = userId,
                DataAtendimento = DateTime.UtcNow,
                AcaoRealizada = "Iniciou atendimento",
                TempoGasto = 0
            };

            _db.Atendimentos.Add(atendimento);
            await _db.SaveChangesAsync();

            return RedirectToAction("Atendimento");
        }

        // Registrar ação (form action='/registrar-acao')
        [HttpPost]
        [Authorize]
        [Route("registrar-acao")]
        [Route("Site/RegistrarAcao")]
        public async Task<IActionResult> RegistrarAcao(int chamado_id, string acao_realizada, int tempo_gasto, IFormFile? anexo_evidencia)
        {
            var userIdClaim = User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
            if (!int.TryParse(userIdClaim, out var userId)) return RedirectToAction("Page", new { viewName = "Login" });
            var chamado = await _db.Chamados.FirstOrDefaultAsync(c => c.ChamadoId == chamado_id);
            if (chamado == null) return NotFound();
            // Only assigned technician or manager/admin can register
            var role = User.FindFirst(ClaimTypes.Role)?.Value;
            if (chamado.TecnicoResponsavelId != userId && role != "2" && role != "1") return Forbid();

            var atendimento = new Atendimento
            {
                ChamadoId = chamado.ChamadoId,
                UsuarioTecnicoId = userId,
                DataAtendimento = DateTime.UtcNow,
                AcaoRealizada = acao_realizada,
                TempoGasto = tempo_gasto
            };
            _db.Atendimentos.Add(atendimento);
            await _db.SaveChangesAsync();

            // handle evidence attachment
            if (anexo_evidencia != null && anexo_evidencia.Length > 0)
            {
                if (anexo_evidencia.Length > MaxUploadBytes) TempData["ErrorMessage"] = "Arquivo excede o limite de5MB.";
                else
                {
                    var ext = Path.GetExtension(anexo_evidencia.FileName).ToLowerInvariant();
                    if (!AllowedExtensions.Contains(ext)) TempData["ErrorMessage"] = "Tipo de arquivo não permitido.";
                    else
                    {
                        var uploadsDir = Path.Combine(_env.WebRootPath ?? Path.Combine(Directory.GetCurrentDirectory(), "wwwroot"), "uploads");
                        var uniqueFileName = $"{Guid.NewGuid():N}_{Path.GetFileName(anexo_evidencia.FileName)}";
                        var filePath = Path.Combine(uploadsDir, uniqueFileName);
                        using (var stream = System.IO.File.Create(filePath)) await anexo_evidencia.CopyToAsync(stream);
                        var anexo = new Anexo { ChamadoId = chamado.ChamadoId, NomeArquivo = anexo_evidencia.FileName, TipoArquivo = anexo_evidencia.ContentType, CaminhoArquivo = "/uploads/" + uniqueFileName, DataUpload = DateTime.UtcNow, UsuarioId = userId };
                        _db.Anexos.Add(anexo);
                        await _db.SaveChangesAsync();
                        TempData["SuccessMessage"] = "Ação registrada e anexo salvo.";
                    }
                }
            }

            try { await SendNotificationEmailAsync((await _db.Usuarios.FindAsync(chamado.UsuarioSolicitanteId))?.Email, "Atualização no seu chamado", $"Uma nova ação foi registrada no chamado {chamado.Protocolo}."); } catch { }

            return RedirectToAction("DetalhesMeuChamado", new { id = chamado.ChamadoId });
        }

        // Enviar mensagem (comunicacao)
        [HttpPost]
        [Authorize]
        [Route("enviar-mensagem")]
        [Route("Site/EnviarMensagem")]
        public async Task<IActionResult> EnviarMensagem(int chamado_id, string mensagem)
        {
            var userIdClaim = User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
            if (!int.TryParse(userIdClaim, out var userId)) return RedirectToAction("Page", new { viewName = "Login" });
            var chamado = await _db.Chamados.FirstOrDefaultAsync(c => c.ChamadoId == chamado_id);
            if (chamado == null) return NotFound();

            var comunicacao = new Comunicacao
            {
                ChamadoId = chamado.ChamadoId,
                UsuarioId = userId,
                Mensagem = mensagem,
                DataEnvio = DateTime.UtcNow
            };
            _db.Comunicacoes.Add(comunicacao);
            await _db.SaveChangesAsync();

            TempData["SuccessMessage"] = "Mensagem enviada.";
            try { await SendNotificationEmailAsync((await _db.Usuarios.FindAsync(chamado.UsuarioSolicitanteId))?.Email, $"Nova mensagem no chamado {chamado.Protocolo}", mensagem); } catch { }
            return RedirectToAction("DetalhesMeuChamado", new { id = chamado.ChamadoId });
        }

        // Resolver chamado
        [HttpPost]
        [Authorize]
        [Route("resolver-chamado")]
        [Route("Site/ResolverChamado")]
        public async Task<IActionResult> ResolverChamado(int chamado_id, string solucao_final)
        {
            var userIdClaim = User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
            if (!int.TryParse(userIdClaim, out var userId)) return RedirectToAction("Page", new { viewName = "Login" });
            var chamado = await _db.Chamados.FirstOrDefaultAsync(c => c.ChamadoId == chamado_id);
            if (chamado == null) return NotFound();
            // only assigned technician or manager/admin
            var role = User.FindFirst(ClaimTypes.Role)?.Value;
            if (chamado.TecnicoResponsavelId != userId && role != "2" && role != "1") return Forbid();

            chamado.DataFechamento = DateTime.UtcNow;
            // set status to closed if exists
            var status = await _db.StatusChamados.FirstOrDefaultAsync(s => EF.Functions.ILike(s.NomeStatus, "%fechado%"));
            if (status != null) chamado.StatusId = status.StatusId;

            // create atendimento record with final solution
            var atendimento = new Atendimento
            {
                ChamadoId = chamado.ChamadoId,
                UsuarioTecnicoId = userId,
                DataAtendimento = DateTime.UtcNow,
                AcaoRealizada = solucao_final ?? "Resolvido",
                TempoGasto = 0
            };
            _db.Atendimentos.Add(atendimento);
            await _db.SaveChangesAsync();

            TempData["SuccessMessage"] = "Chamado marcado como resolvido.";
            try { await SendNotificationEmailAsync((await _db.Usuarios.FindAsync(chamado.UsuarioSolicitanteId))?.Email, $"Chamado {chamado.Protocolo} resolvido", solucao_final); } catch { }

            return RedirectToAction("DetalhesMeuChamado", new { id = chamado.ChamadoId });
        }

        // Escalonar chamado (route used by form '/escalonar-chamado')
        [HttpPost]
        [Authorize]
        [Route("escalonar-chamado")]
        public async Task<IActionResult> EscalonarChamado(int chamado_id, string novo_tecnico, string motivo, string nova_prioridade)
        {
            var userIdClaim = User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
            if (!int.TryParse(userIdClaim, out var userId)) return RedirectToAction("Page", new { viewName = "Login" });
            var chamado = await _db.Chamados.FirstOrDefaultAsync(c => c.ChamadoId == chamado_id);
            if (chamado == null) return NotFound();

            // resolve novo_tecnico either as id or name
            int novoTecnicoId = 0;
            if (int.TryParse(novo_tecnico, out var parsed)) novoTecnicoId = parsed;
            else
            {
                var u = await _db.Usuarios.FirstOrDefaultAsync(x => x.NomeCompleto != null && x.NomeCompleto.ToLower().Contains(novo_tecnico.ToLower()));
                if (u != null) novoTecnicoId = u.UsuarioId;
            }
            if (novoTecnicoId > 0) chamado.TecnicoResponsavelId = novoTecnicoId;

            if (!string.IsNullOrWhiteSpace(nova_prioridade))
            {
                var p = await _db.Prioridades.FirstOrDefaultAsync(x => x.NomePrioridade != null && EF.Functions.ILike(x.NomePrioridade, $"%{nova_prioridade}%"));
                if (p != null) chamado.PrioridadeId = p.PrioridadeId;
            }

            // add history communication
            var comunicacao = new Comunicacao
            {
                ChamadoId = chamado.ChamadoId,
                UsuarioId = userId,
                Mensagem = $"Escalonado: {motivo}",
                DataEnvio = DateTime.UtcNow
            };
            _db.Comunicacoes.Add(comunicacao);
            await _db.SaveChangesAsync();

            TempData["SuccessMessage"] = "Chamado escalonado.";
            try { await SendNotificationEmailAsync((await _db.Usuarios.FindAsync(chamado.UsuarioSolicitanteId))?.Email, $"Chamado {chamado.Protocolo} escalonado", motivo); } catch { }

            return RedirectToAction("DetalhesMeuChamado", new { id = chamado.ChamadoId });
        }

        // Devolutiva chamado (form action='/devolver-chamado')
        [HttpPost]
        [Authorize]
        [Route("devolver-chamado")]
        [Route("Site/DevolverChamado")]
        public async Task<IActionResult> DevolverChamado(int chamado_id, string motivo_devolucao)
        {
            var userIdClaim = User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
            if (!int.TryParse(userIdClaim, out var userId)) return RedirectToAction("Page", new { viewName = "Login" });
            var chamado = await _db.Chamados.FirstOrDefaultAsync(c => c.ChamadoId == chamado_id);
            if (chamado == null) return NotFound();
            // only assigned technician or manager/admin
            var role = User.FindFirst(ClaimTypes.Role)?.Value;
            if (chamado.TecnicoResponsavelId != userId && role != "2" && role != "1") return Forbid();

            chamado.TecnicoResponsavelId = null;

            var comunicacao = new Comunicacao
            {
                ChamadoId = chamado.ChamadoId,
                UsuarioId = userId,
                Mensagem = $"Devolvido para fila: {motivo_devolucao}",
                DataEnvio = DateTime.UtcNow
            };
            _db.Comunicacoes.Add(comunicacao);
            await _db.SaveChangesAsync();

            TempData["SuccessMessage"] = "Chamado devolvido para fila.";
            try { await SendNotificationEmailAsync((await _db.Usuarios.FindAsync(chamado.UsuarioSolicitanteId))?.Email, $"Chamado {chamado.Protocolo} devolvido", motivo_devolucao); } catch { }

            return RedirectToAction("Atendimento");
        }

        // Aprovar/Reprovar usuário
        [HttpPost]
        [Authorize(Roles = "1")] // only admin
        [Route("Site/AprovarUsuario")]
        [Route("aprovar-usuario")]
        public async Task<IActionResult> AprovarUsuario(int solicitacao_id, string perfil, string departamento)
        {
            // try find user by id or by solicitacao id mapping -- we'll assume solicitacao_id is usuario_id
            var user = await _db.Usuarios.FirstOrDefaultAsync(u => u.UsuarioId == solicitacao_id);
            if (user == null) return NotFound();
            // resolve perfil name to id
            var p = await _db.PerfisUsuario.FirstOrDefaultAsync(x => x.NomePerfil != null && EF.Functions.ILike(x.NomePerfil, $"%{perfil}%"));
            if (p != null) user.PerfilId = p.PerfilId;
            // optionally set departamento
            if (!string.IsNullOrWhiteSpace(departamento))
            {
                var d = await _db.Departamentos.FirstOrDefaultAsync(x => x.NomeDepartamento != null && EF.Functions.ILike(x.NomeDepartamento, $"%{departamento}%"));
                if (d != null) user.DepartamentoId = d.DepartamentoId;
            }
            await _db.SaveChangesAsync();
            return RedirectToAction("Page", new { viewName = "GerenciarUsuarios" });
        }

        [HttpPost]
        [Authorize(Roles = "1")]
        [Route("Site/ReprovarUsuario")]
        [Route("reprovar-usuario")]
        public async Task<IActionResult> ReprovarUsuario(int solicitacao_id)
        {
            var user = await _db.Usuarios.FirstOrDefaultAsync(u => u.UsuarioId == solicitacao_id);
            if (user == null) return NotFound();
            // here we delete the user (or mark as rejected) - we'll delete
            _db.Usuarios.Remove(user);
            await _db.SaveChangesAsync();
            return RedirectToAction("Page", new { viewName = "GerenciarUsuarios" });
        }

        // Admin: Gerenciar Usuarios (GET)
        [HttpGet]
        [Authorize(Roles = "1")]
        [Route("Site/GerenciarUsuarios")]
        public async Task<IActionResult> GerenciarUsuarios()
        {
            var users = await _db.Usuarios
            .Include(u => u.Departamento)
            .Include(u => u.PerfilUsuario)
            .OrderBy(u => u.UsuarioId)
            .ToListAsync();

            var model = new PIM_FINAL.Models.AdminUsersViewModel();
            model.ActiveUsers = users.Where(u => u.PerfilId != null).ToList();
            model.PendingUsers = users.Where(u => u.PerfilId == null).ToList();

            return View("~/Views/site/GerenciarUsuarios.cshtml", model);
        }

        [HttpGet]
        [Authorize]
        [Route("Site/DownloadAnexo/{id}")]
        public IActionResult DownloadAnexo(int id)
        {
            var anexo = _db.Anexos.Find(id);
            if (anexo == null || string.IsNullOrEmpty(anexo.CaminhoArquivo)) return NotFound();
            var relative = anexo.CaminhoArquivo.TrimStart('/').Replace('/', Path.DirectorySeparatorChar);
            var physical = Path.Combine(_env.WebRootPath ?? Path.Combine(Directory.GetCurrentDirectory(), "wwwroot"), relative);
            if (!System.IO.File.Exists(physical)) return NotFound();
            var contentType = anexo.TipoArquivo ?? "application/octet-stream";
            return PhysicalFile(physical, contentType, anexo.NomeArquivo);
        }

        // Editar usuário (admin)
        [HttpGet]
        [Authorize(Roles = "1")]
        [Route("Site/EditarUsuario/{id}")]
        public async Task<IActionResult> EditarUsuario(int id)
        {
            var user = await _db.Usuarios
                .Include(u => u.Departamento)
                .Include(u => u.PerfilUsuario)
                .FirstOrDefaultAsync(u => u.UsuarioId == id);
            if (user == null) return NotFound();

            var perfis = await _db.PerfisUsuario.OrderBy(p => p.NomePerfil).ToListAsync();
            var deps = await _db.Departamentos.OrderBy(d => d.NomeDepartamento).ToListAsync();

            var vm = new PIM_FINAL.Models.EditUsuarioViewModel
            {
                UsuarioId = user.UsuarioId,
                NomeCompleto = user.NomeCompleto,
                Email = user.Email,
                PerfilId = user.PerfilId,
                DepartamentoId = user.DepartamentoId,
                Perfis = perfis.Select(p => new Microsoft.AspNetCore.Mvc.Rendering.SelectListItem(p.NomePerfil, p.PerfilId.ToString())).ToList(),
                Departamentos = deps.Select(d => new Microsoft.AspNetCore.Mvc.Rendering.SelectListItem(d.NomeDepartamento, d.DepartamentoId.ToString())).ToList()
            };

            return View("~/Views/site/EditarUsuario.cshtml", vm);
        }

        [HttpPost]
        [Authorize(Roles = "1")]
        [Route("Site/EditarUsuario/{id}")]
        public async Task<IActionResult> EditarUsuario(int id, PIM_FINAL.Models.EditUsuarioViewModel vm)
        {
            if (id != vm.UsuarioId) return BadRequest();
            if (!ModelState.IsValid)
            {
                // reload selects
                vm.Perfis = (await _db.PerfisUsuario.OrderBy(p => p.NomePerfil).ToListAsync()).Select(p => new Microsoft.AspNetCore.Mvc.Rendering.SelectListItem(p.NomePerfil, p.PerfilId.ToString())).ToList();
                vm.Departamentos = (await _db.Departamentos.OrderBy(d => d.NomeDepartamento).ToListAsync()).Select(d => new Microsoft.AspNetCore.Mvc.Rendering.SelectListItem(d.NomeDepartamento, d.DepartamentoId.ToString())).ToList();
                return View("~/Views/site/EditarUsuario.cshtml", vm);
            }

            var user = await _db.Usuarios.FirstOrDefaultAsync(u => u.UsuarioId == id);
            if (user == null) return NotFound();

            user.NomeCompleto = vm.NomeCompleto;
            user.Email = vm.Email;
            user.PerfilId = vm.PerfilId;
            user.DepartamentoId = vm.DepartamentoId;

            if (!string.IsNullOrWhiteSpace(vm.NewPassword))
            {
                var hasher = new PasswordHasher<Usuario>();
                user.Senha = hasher.HashPassword(user, vm.NewPassword);
            }

            await _db.SaveChangesAsync();
            TempData["SuccessMessage"] = "Usuário atualizado com sucesso.";
            return RedirectToAction("GerenciarUsuarios");
        }

        [HttpGet]
        [Authorize]
        [Route("Site/InicialPainel")]
        public async Task<IActionResult> InicialPainel()
        {
            var vm = new InicialPainelViewModel();
            var userIdClaim = User?.FindFirst(ClaimTypes.NameIdentifier)?.Value;
            if (int.TryParse(userIdClaim, out var userId))
            {
                var user = await _db.Usuarios.Include(u => u.Departamento).Include(u => u.PerfilUsuario).FirstOrDefaultAsync(u => u.UsuarioId == userId);
                vm.NomeUsuario = user?.NomeCompleto ?? User?.Identity?.Name;
                vm.Perfil = user?.PerfilUsuario?.NomePerfil ?? (User?.FindFirst(ClaimTypes.Role)?.Value ?? "");
            }
            else
            {
                vm.NomeUsuario = User?.Identity?.Name ?? "(anônimo)";
                vm.Perfil = "(não autenticado)";
            }

            // Recent notifications: include latest Comunicacoes and Anexos for chamados owned by the user
            int uid = 0;
            int.TryParse(userIdClaim, out uid);
            var notifications = new List<(DateTime When, string Text)>();
            if (uid > 0)
            {
                var comms = await _db.Comunicacoes
                .Where(c => c.Chamado.UsuarioSolicitanteId == uid || c.UsuarioId == uid)
                .Include(c => c.Chamado)
                .OrderByDescending(c => c.DataEnvio)
                .Take(10)
                .ToListAsync();
                foreach (var c in comms)
                {
                    var when = c.DataEnvio ?? DateTime.UtcNow;
                    var proto = c.Chamado?.Protocolo ?? "#?";
                    notifications.Add((when, $"[{proto}] {c.Mensagem}"));
                }

                var anexos = await _db.Anexos
                .Where(a => a.Chamado.UsuarioSolicitanteId == uid || a.UsuarioId == uid)
                .Include(a => a.Chamado)
                .OrderByDescending(a => a.DataUpload)
                .Take(10)
                .ToListAsync();
                foreach (var a in anexos)
                {
                    var when = a.DataUpload ?? DateTime.UtcNow;
                    var proto = a.Chamado?.Protocolo ?? "#?";
                    notifications.Add((when, $"[{proto}] Anexo enviado: {a.NomeArquivo}"));
                }
            }

            vm.RecentNotifications = notifications
            .OrderByDescending(n => n.When)
            .Take(5)
            .Select(n => n.Text)
            .ToList();
            if (!vm.RecentNotifications.Any()) vm.RecentNotifications.Add("Nenhuma notificação recente.");

            // KPIs
            vm.ChamadosEmEspera = await _db.Chamados.CountAsync(c => c.StatusId == null || (c.StatusChamado != null && EF.Functions.ILike(c.StatusChamado.NomeStatus, "%abert%")));
            vm.ChamadosEmAtendimento = await _db.Chamados.CountAsync(c => c.StatusChamado != null && EF.Functions.ILike(c.StatusChamado.NomeStatus, "%atend%"));
            var hojeStart = DateTime.UtcNow.Date;
            var hojeEnd = hojeStart.AddDays(1);
            vm.ResolvidosHoje = await _db.Chamados.CountAsync(c => c.DataFechamento != null && c.DataFechamento >= hojeStart && c.DataFechamento < hojeEnd);
            var total = await _db.Chamados.CountAsync();
            // Use sla_atingido column as SLA met indicator
            var slaMet = await _db.Chamados.CountAsync(c => c.SlaAtingido == true);
            vm.SLACumpridoPercent = total == 0 ? 100 : (int)Math.Round((double)slaMet / Math.Max(1, total) * 100);

            return View("~/Views/site/InicialPainel.cshtml", vm);
        }

        // Utility: build CSV FileContentResult
        private FileContentResult CsvDownload(string fileName, IEnumerable<string> lines)
        {
            var sb = new StringBuilder();
            foreach (var l in lines) sb.AppendLine(l);
            var bytes = Encoding.UTF8.GetBytes(sb.ToString());
            return File(bytes, "text/csv; charset=utf-8", fileName);
        }

        // Dashboard export (called by a form with action "/exportar-dashboard")
        [HttpPost]
        [Authorize(Roles = "1,2")]
        [Route("exportar-dashboard")]
        public async Task<IActionResult> ExportarDashboard()
        {
            var total = await _db.Chamados.CountAsync();
            var resolvidos = await _db.Chamados.CountAsync(c => c.DataFechamento != null);
            var taxa = total == 0 ? 100.0 : Math.Round(resolvidos * 100.0 / total, 1);
            var sla = total == 0 ? 100 : (int)Math.Round((await _db.Chamados.CountAsync(c => c.SlaAtingido == true)) * 100.0 / Math.Max(1, total));
            var linhas = new List<string>
 {
 "KPI,Valor",
 $"TotalChamados,{total}",
 $"ChamadosResolvidos,{resolvidos}",
 $"TaxaResolucaoPercent,{taxa}",
 $"SLACumpridoPercent,{sla}"
 };
            return CsvDownload($"dashboard_{DateTime.UtcNow:yyyyMMddHHmmss}.csv", linhas);
        }

        // Relatórios: aceitar POST das páginas que usam handler via query (?handler=GerarRelatorio / ?handler=ExportarCompleto)
        [HttpPost]
        [Authorize(Roles = "1,2")]
        [Route("Site/Relatorios")]
        public async Task<IActionResult> RelatoriosPost([FromQuery] string? handler, string? periodo, string? formato, string? tipo_relatorio)
        {
            handler = handler?.ToLowerInvariant();
            if (handler == "exportarcompleto")
            {
                // Exportar conjunto simples de dados (CSV) como prova de conceito
                var chamados = await _db.Chamados.Include(c => c.Prioridade).Include(c => c.StatusChamado).ToListAsync();
                var linhas = new List<string> { "Protocolo,Titulo,Status,Prioridade,DataAbertura,DataFechamento" };
                foreach (var c in chamados)
                {
                    linhas.Add($"{c.Protocolo},{c.Titulo.Replace(',', ';')},{c.StatusChamado?.NomeStatus},{c.Prioridade?.NomePrioridade},{c.DataAbertura:O},{c.DataFechamento:O}");
                }
                return CsvDownload($"relatorios_completo_{DateTime.UtcNow:yyyyMMddHHmmss}.csv", linhas);
            }
            if (handler == "gerarrelatorio")
            {
                // Geração simples conforme período (CSV)
                DateTime inicio = DateTime.UtcNow.Date;
                if (string.Equals(periodo, "semana", StringComparison.OrdinalIgnoreCase)) inicio = inicio.AddDays(-7);
                else if (string.Equals(periodo, "mes", StringComparison.OrdinalIgnoreCase)) inicio = inicio.AddDays(-30);
                var chamados = await _db.Chamados.Where(c => c.DataAbertura >= inicio).Include(c => c.Prioridade).Include(c => c.StatusChamado).ToListAsync();
                var linhas = new List<string> { "Protocolo,Titulo,Status,Prioridade,DataAbertura" };
                foreach (var c in chamados)
                {
                    linhas.Add($"{c.Protocolo},{c.Titulo.Replace(',', ';')},{c.StatusChamado?.NomeStatus},{c.Prioridade?.NomePrioridade},{c.DataAbertura:O}");
                }
                return CsvDownload($"relatorio_{periodo ?? "hoje"}_{DateTime.UtcNow:yyyyMMddHHmmss}.csv", linhas);
            }
            // fallback: voltar para view
            return RedirectToAction("Relatorios");
        }

        // Enhanced Dashboard with avg resolution time and team performance
        [HttpGet]
        [Authorize(Roles = "1,2")]
        [Route("Site/DashboardGestor")]
        public async Task<IActionResult> DashboardGestor()
        {
            var vm = new DashboardGestorViewModel();
            vm.TotalChamados = await _db.Chamados.CountAsync();
            vm.ChamadosResolvidos = await _db.Chamados.CountAsync(c => c.DataFechamento != null);
            vm.TaxaResolucaoPercent = vm.TotalChamados == 0 ? 100 : Math.Round((double)vm.ChamadosResolvidos / vm.TotalChamados * 100, 1);
            vm.SLACumpridoPercent = vm.TotalChamados == 0 ? 100 : (int)Math.Round((double)(await _db.Chamados.CountAsync(c => c.SlaAtingido == true)) / Math.Max(1, vm.TotalChamados) * 100);
            var avals = await _db.Avaliacoes.ToListAsync();
            if (avals.Any()) { vm.SatisfacaoMedia = Math.Round(avals.Average(a => a.Nota), 2); vm.TotalAvaliacoes = avals.Count; }

            // Tempo médio real (resolvidos)
            var resolvidos = await _db.Chamados.Where(c => c.DataFechamento != null && c.DataAbertura != null).Select(c => new { c.DataAbertura, c.DataFechamento }).ToListAsync();
            if (resolvidos.Any())
            {
                var avgSeconds = resolvidos.Average(c => (c.DataFechamento!.Value - c.DataAbertura!.Value).TotalSeconds);
                var ts = TimeSpan.FromSeconds(avgSeconds);
                vm.TempoMedioResolucao = ts.TotalHours >= 1 ? $"{(int)ts.TotalHours}h{ts.Minutes}m" : $"{ts.Minutes}m";
            }

            // Desempenho por técnico (básico): contagem de chamados atribuídos e resolvidos
            var tecnicos = await _db.Usuarios.Where(u => u.PerfilId == 1 || u.PerfilId == 2 || u.PerfilId == 3).ToListAsync();
            foreach (var t in tecnicos)
            {
                var atendidos = await _db.Chamados.CountAsync(c => c.TecnicoResponsavelId == t.UsuarioId);
                var resolv = await _db.Chamados.CountAsync(c => c.TecnicoResponsavelId == t.UsuarioId && c.DataFechamento != null);
                var taxa = atendidos == 0 ? 0 : Math.Round(resolv * 100.0 / atendidos, 1);
                vm.DesempenhoEquipe.Add((t.NomeCompleto ?? "-", atendidos, resolv, taxa, "-", 0));
            }
            return View("~/Views/site/DashboardGestor.cshtml", vm);
        }

        // Aliases for "from Views" links
        [HttpGet]
        [Authorize]
        [Route("Site/AbrirChamado_FromViews")]
        public IActionResult AbrirChamado_FromViews() => RedirectToAction("AbrirChamado");

        [HttpGet]
        [Authorize]
        [Route("Site/Escalonamento_FromViews")]
        public IActionResult Escalonamento_FromViews() => RedirectToAction("Escalonamento");

        [HttpGet]
        [Authorize(Roles = "1,2")]
        [Route("Site/DashboardGestor_FromViews")]
        public IActionResult DashboardGestor_FromViews() => RedirectToAction("DashboardGestor");

        [HttpGet]
        [Authorize]
        [Route("Site/DetalhesEscalonamento_FromViews/{id}")]
        public IActionResult DetalhesEscalonamento_FromViews(int id) => RedirectToAction("DetalhesEscalonamento", new { id });

        // Public GET views (Login/Cadastro/Recuperar/Validar)
        [HttpGet]
        [AllowAnonymous]
        [Route("Site/Login")]
        public IActionResult LoginView() => View("~/Views/site/Login.cshtml");

        [HttpGet]
        [AllowAnonymous]
        [Route("Site/Cadastro")]
        public IActionResult CadastroView() => View("~/Views/site/Cadastro.cshtml");

        [HttpGet]
        [AllowAnonymous]
        [Route("Site/RecuperarSenha")]
        public IActionResult RecuperarSenhaView() => View("~/Views/site/RecuperarSenha.cshtml");

        [HttpGet]
        [AllowAnonymous]
        [Route("Site/ValidarCodigoRedefinir")]
        public IActionResult ValidarCodigoRedefinirView() => View("~/Views/site/ValidarCodigoRedefinir.cshtml");

        // Detalhes Escalonamento (GET)
        [HttpGet]
        [Authorize]
        [Route("Site/DetalhesEscalonamento/{id}")]
        public async Task<IActionResult> DetalhesEscalonamento(int id)
        {
            var chamado = await _db.Chamados
            .Include(c => c.Prioridade)
            .Include(c => c.StatusChamado)
            .Include(c => c.Categoria)
            .Include(c => c.Sla)
            .FirstOrDefaultAsync(c => c.ChamadoId == id);
            if (chamado == null) return NotFound();

            ViewBag.chamadoId = chamado.ChamadoId;
            ViewBag.protocolo = chamado.Protocolo;
            // compute SLA consumption/remaining
            if (chamado.Sla != null && chamado.DataAbertura.HasValue && !chamado.DataFechamento.HasValue)
            {
                var elapsed = DateTime.UtcNow - chamado.DataAbertura.Value;
                var slaResolution = TimeSpan.FromHours(chamado.Sla.TempoMaximoResolucao);
                var consumed = (int)Math.Min(100, (elapsed.TotalSeconds / Math.Max(1, slaResolution.TotalSeconds)) * 100);
                var remaining = slaResolution - elapsed;
                ViewBag.SlaConsumed = consumed;
                ViewBag.SlaRemaining = remaining > TimeSpan.Zero ? $"{(int)remaining.TotalHours}h{remaining.Minutes}min" : "0min";
            }

            return View("~/Views/site/DetalhesEscalonamento.cshtml", chamado);
        }

        // Fix Escalonamento GET duplicate signature: keep one with optional filters
        [HttpGet]
        [Authorize]
        [Route("Site/Escalonamento")]
        public async Task<IActionResult> Escalonamento(string? urgencia = null, string? protocolo = null)
        {
            var role = User.FindFirst(ClaimTypes.Role)?.Value;
            bool isTecnico = role == "3" || role == "2" || role == "1";
            if (!isTecnico) return Forbid();

            var chamados = await _db.Chamados
            .Include(c => c.Prioridade)
            .Include(c => c.TecnicoResponsavel)
            .Include(c => c.Sla)
            .Where(c => c.DataAbertura != null && c.DataFechamento == null)
            .ToListAsync();

            if (!string.IsNullOrWhiteSpace(protocolo))
            {
                chamados = chamados.Where(c => c.Protocolo != null && c.Protocolo.Contains(protocolo, StringComparison.OrdinalIgnoreCase)).ToList();
            }

            var list = new List<ChamadoSummary>();
            foreach (var c in chamados)
            {
                var sla = c.Sla;
                if (sla == null) continue;
                var opened = c.DataAbertura ?? DateTime.UtcNow;
                var elapsed = DateTime.UtcNow - opened;
                var slaResolution = TimeSpan.FromHours(sla.TempoMaximoResolucao);
                var consumed = (int)Math.Min(100, (elapsed.TotalSeconds / Math.Max(1, slaResolution.TotalSeconds)) * 100);
                var include = consumed >= 50;
                if (!string.IsNullOrEmpty(urgencia))
                {
                    if (urgencia.Equals("sla_75", StringComparison.OrdinalIgnoreCase)) include = consumed >= 75;
                    else if (urgencia.Equals("sla_50", StringComparison.OrdinalIgnoreCase)) include = consumed >= 50 && consumed < 75;
                }
                if (!include) continue;
                var remaining = slaResolution - elapsed;
                list.Add(new ChamadoSummary
                {
                    ChamadoId = c.ChamadoId,
                    Protocolo = c.Protocolo,
                    Titulo = c.Titulo,
                    Prioridade = c.Prioridade?.NomePrioridade,
                    Tecnico = c.TecnicoResponsavel?.NomeCompleto ?? "(sem técnico)",
                    SlaConsumedPercent = consumed,
                    TimeRemaining = remaining > TimeSpan.Zero ? remaining : TimeSpan.Zero
                });
            }

            return View("~/Views/site/Escalonamento.cshtml", list);
        }

        // Restore missing actions (Configuracao, Relatorios GET, AprovarUsuario GET)
        // GET Configuração (admin)
        [HttpGet]
        [Authorize(Roles = "1")]
        [Route("Site/Configuracao")]
        public async Task<IActionResult> Configuracao()
        {
            var deps = await _db.Departamentos.OrderBy(d => d.NomeDepartamento).ToListAsync();
            var perfis = await _db.PerfisUsuario.OrderBy(p => p.NomePerfil).ToListAsync();
            ViewBag.Departamentos = deps;
            ViewBag.Perfis = perfis;
            return View("~/Views/site/Configuracao.cshtml");
        }

        // GET AprovarUsuario page (admin) shows pending users (PerfilId null)
        [HttpGet]
        [Authorize(Roles = "1")]
        [Route("Site/AprovarUsuario")]
        public async Task<IActionResult> AprovarUsuarioView()
        {
            var pendentes = await _db.Usuarios.Where(u => u.PerfilId == null).OrderBy(u => u.UsuarioId).ToListAsync();
            ViewBag.Pendentes = pendentes;
            return View("~/Views/site/AprovarUsuario.cshtml");
        }

        // GETRelatorios (build model)
        [HttpGet]
        [Authorize(Roles = "1,2")]
        [Route("Site/Relatorios")]
        public async Task<IActionResult> Relatorios(string? periodo = "hoje")
        {
            var vm = await BuildRelatoriosViewModel(periodo);
            return View("~/Views/site/Relatorios.cshtml", vm);
        }

        private async Task<RelatoriosViewModel> BuildRelatoriosViewModel(string? periodo)
        {
            DateTime fim = DateTime.UtcNow;
            DateTime inicio = fim.Date;
            if (string.Equals(periodo, "semana", StringComparison.OrdinalIgnoreCase)) inicio = inicio.AddDays(-7);
            else if (string.Equals(periodo, "mes", StringComparison.OrdinalIgnoreCase)) inicio = inicio.AddDays(-30);
            var vm = new RelatoriosViewModel { PeriodoInicio = inicio, PeriodoFim = fim };
            var chamadosPeriodo = await _db.Chamados
            .Include(c => c.StatusChamado)
            .Include(c => c.Prioridade)
            .Include(c => c.Categoria)
            .Include(c => c.UsuarioSolicitante).ThenInclude(u => u.Departamento)
            .Where(c => c.DataAbertura >= inicio && c.DataAbertura <= fim)
            .ToListAsync();
            vm.TotalChamadosPeriodo = chamadosPeriodo.Count;
            vm.TotalResolvidosPeriodo = chamadosPeriodo.Count(c => c.DataFechamento != null);
            vm.TaxaResolucaoPercent = vm.TotalChamadosPeriodo == 0 ? 100 : Math.Round(vm.TotalResolvidosPeriodo * 100.0 / vm.TotalChamadosPeriodo, 1);
            var resolvidos = chamadosPeriodo.Where(c => c.DataFechamento != null).ToList();
            if (resolvidos.Any())
            {
                var avgSec = resolvidos.Average(c => (c.DataFechamento!.Value - c.DataAbertura!.Value).TotalSeconds);
                var ts = TimeSpan.FromSeconds(avgSec);
                vm.TempoMedioResolucao = ts.TotalHours >= 1 ? $"{(int)ts.TotalHours}h{ts.Minutes}m" : $"{ts.Minutes}m";
            }
            foreach (var grp in chamadosPeriodo.GroupBy(c => c.StatusChamado?.NomeStatus ?? "(sem status)"))
            {
                var pct = vm.TotalChamadosPeriodo == 0 ? 0 : Math.Round(grp.Count() * 100.0 / vm.TotalChamadosPeriodo, 1);
                vm.Status.Add(new ItemResumo { Nome = grp.Key, Quantidade = grp.Count(), Percentual = pct });
            }
            foreach (var grp in chamadosPeriodo.GroupBy(c => c.Prioridade?.NomePrioridade ?? "(sem)"))
            {
                var pct = vm.TotalChamadosPeriodo == 0 ? 0 : Math.Round(grp.Count() * 100.0 / vm.TotalChamadosPeriodo, 1);
                vm.Prioridades.Add(new ItemResumo { Nome = grp.Key, Quantidade = grp.Count(), Percentual = pct });
            }
            foreach (var grp in chamadosPeriodo.GroupBy(c => c.Categoria?.NomeCategoria ?? "(sem)"))
            {
                var pct = vm.TotalChamadosPeriodo == 0 ? 0 : Math.Round(grp.Count() * 100.0 / vm.TotalChamadosPeriodo, 1);
                vm.Categorias.Add(new ItemResumo { Nome = grp.Key, Quantidade = grp.Count(), Percentual = pct });
            }
            foreach (var grp in chamadosPeriodo.GroupBy(c => c.UsuarioSolicitante?.Departamento?.NomeDepartamento ?? "(sem)"))
            {
                var pct = vm.TotalChamadosPeriodo == 0 ? 0 : Math.Round(grp.Count() * 100.0 / vm.TotalChamadosPeriodo, 1);
                vm.Departamentos.Add(new ItemResumo { Nome = grp.Key, Quantidade = grp.Count(), Percentual = pct });
            }
            var tecnicosIds = chamadosPeriodo.Where(c => c.TecnicoResponsavelId != null).Select(c => c.TecnicoResponsavelId!.Value).Distinct().ToList();
            var tecnicos = await _db.Usuarios.Where(u => tecnicosIds.Contains(u.UsuarioId)).ToListAsync();
            foreach (var t in tecnicos)
            {
                var atendidos = chamadosPeriodo.Count(c => c.TecnicoResponsavelId == t.UsuarioId);
                var resolvT = chamadosPeriodo.Count(c => c.TecnicoResponsavelId == t.UsuarioId && c.DataFechamento != null);
                var taxa = atendidos == 0 ? 0 : Math.Round(resolvT * 100.0 / atendidos, 1);
                vm.Tecnicos.Add(new TecnicoResumo { Nome = t.NomeCompleto ?? "-", Atendidos = atendidos, Resolvidos = resolvT, TaxaResolucao = taxa });
            }
            foreach (var grp in chamadosPeriodo.GroupBy(c => c.Prioridade?.NomePrioridade ?? "(sem)"))
            {
                int total = grp.Count();
                int cumpridos = grp.Count(c => c.SlaAtingido == true);
                int violados = total - cumpridos;
                double taxa = total == 0 ? 0 : Math.Round(cumpridos * 100.0 / total, 1);
                vm.SlaPorPrioridade.Add(new SlaResumo { Prioridade = grp.Key, Total = total, Cumpridos = cumpridos, Violados = violados, TaxaCumprimento = taxa });
            }
            var avalsPeriodo = await _db.Avaliacoes.Where(a => a.DataAvaliacao >= inicio && a.DataAvaliacao <= fim).ToListAsync();
            vm.TotalAvaliacoes = avalsPeriodo.Count;
            if (avalsPeriodo.Any()) vm.SatisfacaoMedia = Math.Round(avalsPeriodo.Average(a => a.Nota), 2);
            for (int nota = 1; nota <= 5; nota++)
            {
                int qtd = avalsPeriodo.Count(a => a.Nota == nota);
                double pct = vm.TotalAvaliacoes == 0 ? 0 : Math.Round(qtd * 100.0 / vm.TotalAvaliacoes, 1);
                vm.DistribuicaoNotas.Add(new ItemResumo { Nome = nota + " estrela" + (nota > 1 ? "s" : ""), Quantidade = qtd, Percentual = pct });
            }
            return vm;
        }

        // Recuperar senha (POST gera token fictício)
        [HttpPost]
        [AllowAnonymous]
        [Route("Site/RecuperarSenha")]
        public async Task<IActionResult> RecuperarSenha(string email)
        {
            var user = await _db.Usuarios.FirstOrDefaultAsync(u => u.Email == email);
            if (user == null) { TempData["ErrorMessage"] = "E-mail não encontrado"; return RedirectToAction("RecuperarSenhaView"); }
            var token = Guid.NewGuid().ToString("N").Substring(0, 6).ToUpperInvariant();
            TempData["ResetToken"] = token; // armazenar em memória (ideal: tabela tokens)
            try { await SendNotificationEmailAsync(user.Email, "Código de redefinição", $"Seu código: {token}"); } catch { }
            TempData["SuccessMessage"] = "Código enviado";
            return RedirectToAction("ValidarCodigoRedefinirView");
        }

        // Validar Código Redefinir (POST)
        [HttpPost]
        [AllowAnonymous]
        [Route("Site/ValidarCodigoRedefinir")]
        public async Task<IActionResult> ValidarCodigoRedefinir(string email, string codigo, string novaSenha)
        {
            var stored = TempData["ResetToken"] as string; // simples
            if (stored == null || !string.Equals(stored, codigo, StringComparison.OrdinalIgnoreCase))
            {
                TempData["ErrorMessage"] = "Código inválido ou expirado";
                return RedirectToAction("ValidarCodigoRedefinirView");
            }
            var user = await _db.Usuarios.FirstOrDefaultAsync(u => u.Email == email);
            if (user == null) { TempData["ErrorMessage"] = "Usuário não encontrado"; return RedirectToAction("ValidarCodigoRedefinirView"); }
            if (string.IsNullOrWhiteSpace(novaSenha)) { TempData["ErrorMessage"] = "Senha inválida"; return RedirectToAction("ValidarCodigoRedefinirView"); }
            var hasher = new PasswordHasher<Usuario>();
            user.Senha = hasher.HashPassword(user, novaSenha);
            await _db.SaveChangesAsync();
            TempData["SuccessMessage"] = "Senha redefinida";
            return RedirectToAction("LoginView");
        }

        // Email util
        private async Task SendNotificationEmailAsync(string? to, string subject, string body)
        {
            if (string.IsNullOrWhiteSpace(to)) return;
            var smtpHost = _config["Smtp:Host"]; if (string.IsNullOrWhiteSpace(smtpHost)) return;
            try
            {
                var port = int.TryParse(_config["Smtp:Port"], out var p) ? p : 25;
                var user = _config["Smtp:User"]; var pass = _config["Smtp:Pass"]; using var msg = new MailMessage();
                msg.To.Add(new MailAddress(to)); msg.From = new MailAddress(_config["Smtp:From"] ?? "noreply@example.com"); msg.Subject = subject; msg.Body = body;
                using var client = new SmtpClient(smtpHost, port); if (!string.IsNullOrEmpty(user)) client.Credentials = new System.Net.NetworkCredential(user, pass); client.EnableSsl = bool.TryParse(_config["Smtp:EnableSsl"], out var ssl) && ssl; await client.SendMailAsync(msg);
            }
            catch { }
        }
    }
}
