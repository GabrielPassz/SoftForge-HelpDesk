@model PIM_FINAL.Models.Chamado
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
<link rel="stylesheet" href="/css/dbtestes.css" />
@{ @* Bloco de preparação de variáveis de contexto para exibição *@
 var chamadoId = (Model?.ChamadoId.ToString()) ?? (ViewData["id"] as string) ?? (ViewContext.RouteData.Values["id"]?.ToString()) ?? "0"; // Resolve ID de múltiplas fontes
 var protocolo = ViewBag.protocolo as string ?? Model?.Protocolo ?? ("#CHAM-" + chamadoId); // Fallback de protocolo
 var slaConsumed = ViewBag.SlaConsumed as int?; // Percentual consumido
 var slaRemaining = ViewBag.SlaRemaining as string ?? "-"; // Tempo restante
}

@* Página DetalhesEscalonamento: reclassificação rápida, status de risco SLA, resumo do chamado e formulário de escalonamento. *@
<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Detalhes Escalonamento - SoftForge HelpDesk</title>
</head>
<body>
<div class="db-page container-fluid">
 @await Html.PartialAsync("_HeaderNav")

 <div class="db-content">
 <main>
 <section class="db-section db-reclassificar"> @* Reclassificação de prioridade *@
 <h4>Reclassificar Prioridade (sem escalonamento)</h4>
 <form method="post" asp-controller="Site" asp-action="EscalonarChamado">
 <input type="hidden" name="chamado_id" value="@chamadoId" />
 <label for="prioridade_nova">Nova Prioridade:</label>
 <select id="prioridade_nova" name="nova_prioridade" class="form-select" required>
 <option value="critica">Crítica</option><option value="alta">Alta</option><option value="media">Média</option><option value="baixa">Baixa</option>
 </select>
 <label for="justificativa_prioridade">Justificativa:</label>
 <input type="text" id="justificativa_prioridade" name="motivo" size="50" class="form-control" required />
 <button type="submit" class="btn btn-primary btn-sm">Reclassificar</button>
 </form>
 </section>

 <section class="db-section db-status"> @* Indicadores de risco *@
 <h3>Status de Risco</h3>
                    <table class="table table-bordered w-100 db-summary-table limit-rows" data-limit="3">
                        <thead><tr><th>Campo</th><th>Valor</th></tr></thead>
                        <tbody>
 <tr><td><strong>Nível de Risco</strong></td><td><span class="cell-val">@if (slaConsumed.HasValue){var nivel = slaConsumed.Value >=75 ? "ALTO" : (slaConsumed.Value >=50 ? "MÉDIO" : "BAIXO");<text><strong style="color:@(slaConsumed.Value>=75?"red":(slaConsumed.Value>=50?"orange":"green"))">@nivel - SLA @slaConsumed% Consumido</strong></text>} else {<text><strong>Indisponível</strong></text>}</span></td></tr>
 <tr><td><strong>Tempo Restante SLA</strong></td><td><span class="cell-val">@slaRemaining</span></td></tr>
 </tbody></table>
 </section>

 <section class="db-section db-infos"> @* Resumo chamado *@
 <h3>Informações do Chamado</h3>
 <table class="table table-bordered w-100 db-summary-table limit-rows" data-limit="3">
 <thead><tr><th>Campo</th><th>Valor</th></tr></thead>
 <tbody>
 <tr><td><strong>Protocolo</strong></td><td><span class="cell-val">@protocolo</span></td></tr>
 <tr><td><strong>Status</strong></td><td><span class="cell-val">@(Model?.StatusChamado?.NomeStatus ?? "-")</span></td></tr>
 <tr><td><strong>Título</strong></td><td><span class="cell-val">@(Model?.Titulo ?? "-")</span></td></tr>
 <tr><td><strong>Descrição</strong></td><td><span class="cell-val">@(Model?.Descricao ?? "-")</span></td></tr>
 <tr><td><strong>Categoria</strong></td><td><span class="cell-val">@(Model?.Categoria?.NomeCategoria ?? "-")</span></td></tr>
 <tr><td><strong>Prioridade</strong></td><td><span class="cell-val">@(Model?.Prioridade?.NomePrioridade ?? "-")</span></td></tr>
 <tr><td><strong>Solicitante</strong></td><td><span class="cell-val">@((Model?.UsuarioSolicitante?.NomeCompleto ?? "-") + (Model?.UsuarioSolicitante?.Departamento?.NomeDepartamento != null ? (" - " + Model.UsuarioSolicitante.Departamento.NomeDepartamento) : string.Empty))</span></td></tr>
 <tr><td><strong>Data/Hora Abertura</strong></td><td><span class="cell-val">@(Model?.DataAbertura?.ToLocalTime().ToString("dd/MM/yyyy HH:mm") ?? "-")</span></td></tr>
 <tr><td><strong>Técnico Responsável Atual</strong></td><td><span class="cell-val">@(Model?.TecnicoResponsavel?.NomeCompleto ?? "(sem técnico)")</span></td></tr>
 <tr><td><strong>SLA - Resolução</strong></td><td><span class="cell-val">@if (Model?.Sla != null && Model.DataAbertura != null){var prazo = Model.DataAbertura.Value.AddHours(Model.Sla.TempoMaximoResolucao).ToLocalTime();<text>@Model.Sla.TempoMaximoResolucao horas (Prazo: @prazo:dd/MM/yyyy HH:mm)</text>} else {<text>-</text>}</span></td></tr>
 </tbody></table>
 </section>

 <section class="db-section db-ia"> @* Placeholder IA *@
 <h3>Análise da IA</h3>
 <table class="table table-bordered w-100 db-summary-table limit-rows" data-limit="3"><thead><tr><th>Campo</th><th>Valor</th></tr></thead><tbody>
 <tr><td><strong>Recomendação</strong></td><td><span class="cell-val"><strong style="color:red">ESCALAR (se necessário)</strong></span></td></tr>
 <tr><td><strong>Justificativa</strong></td><td><span class="cell-val">-</span></td></tr>
 <tr><td><strong>Técnico Sugerido</strong></td><td><span class="cell-val">-</span></td></tr>
 </tbody></table>
 </section>

 <section class="db-section db-historico"> @* Histórico *@
 <h3>Histórico</h3>
 @{
 var historico = Model?.Comunicacoes?.OrderByDescending(x => x.DataEnvio).ToList() ?? new List<PIM_FINAL.Models.Comunicacao>();
 }
 @if (historico.Any())
 {
 <table class="table table-bordered w-100 stack-mobile"><thead><tr><th>Data/Hora</th><th>Usuário</th><th>Mensagem</th></tr></thead><tbody>
 @foreach (var h in historico)
 {
 var ts = (h.DataEnvio ?? DateTime.UtcNow).ToLocalTime().ToString("dd/MM/yyyy HH:mm");
 var usr = h.Usuario?.NomeCompleto ?? (h.UsuarioId.ToString() ?? "-");
 <tr class="@(h.Mensagem != null && (h.Mensagem.Contains("Escalonado", StringComparison.OrdinalIgnoreCase) || h.Mensagem.Contains("Escalonamento manual", StringComparison.OrdinalIgnoreCase)) ? "table-warning" : null)">
 <td data-label="Data:"><span class="cell-val">@ts</span></td>
 <td data-label="Técnico:"><span class="cell-val">@usr</span></td>
 <td data-label="Mensagem:"><span class="cell-val">@h.Mensagem</span></td>
 </tr>
 }
 </tbody></table>
 }
 else
 {
 <p>Nenhum histórico disponível.</p>
 }
 </section>

 </main>
 </div>

 <div class="db-footer">
 <footer><p>©2025 SoftForge - Todos os direitos reservados</p></footer>
 </div>
</div>
</body>
</html>
